<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fursys.mobilecm.mapper.ScheduleMainListMapper">

<update id="updateFinalResult" parameterType="HashMap">
<![CDATA[
	UPDATE TC_PLANMST
	   SET FINAL_RESULT = #{final_result}
	 WHERE PLM_NO = #{plm_no}

]]>
</update> 

<select id="selectFinalResult" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.DataResult">
<![CDATA[

	SELECT CASE WHEN #{req_resigong_dt} > A.CAL_YMD THEN 'C79002' ELSE 'C79001' END AS DATA1
	FROM TT_CALENDAR A, TT_CALENDAR B
	WHERE A.COM_CMP = #{com_agsec}  -- 회사코드
	AND A.COM_CSEC = 'T32001'
	AND A.CAL_YMD >= #{plm_cdt} -- 원 시공건의 PLM_CDT
	AND A.CAL_SEC = 'T33N'
	AND B.COM_CMP = #{com_agsec} -- 회사코드
	AND B.COM_CSEC = 'T32001'
	AND B.CAL_YMD >= #{plm_cdt}   -- 원 시공건의 PLM_CDT
	AND B.CAL_SEC = 'T33N'
	AND A.CAL_YMD >= B.CAL_YMD
	GROUP BY A.CAL_YMD
	HAVING COUNT(*) = (SELECT CASE #{com_undsec} WHEN 'C52A01' THEN REF_8 ELSE REF_9 END FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CCD_CD = #{com_scd})
   
]]>
</select>

<select id="selectStiList" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPSti">        
<![CDATA[ 
	SELECT
		A.STI_CD AS STI_CD,
		A.STI_NM AS STI_NM,
		B.CCD_NM AS COM_SCD_NM,
		A.COM_CTSEC AS COM_CTSEC,
		A.COM_SCD AS COM_SCD
	  FROM TC_STINF A WITH (NOLOCK), TT_COMCD B WITH (NOLOCk)
	 WHERE A.COM_SCD = B.CCD_CD 
	   AND A.K_STI_CD = #{k_sti_cd}
       AND A.STI_RANK = 'Y'
       AND B.CDX_CD = 'C16'
       AND B.CCD_YN  = 'Y'
    ORDER BY A.STI_NM, A.STI_CD       
]]>
</select>
<select id="selectKStiList" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPSti">        
<![CDATA[ 
	SELECT A.sti_cd    AS STI_CD,
	       A.sti_nm    AS STI_NM,
	       B.ccd_nm    AS COM_SCD_NM,
	       A.com_ctsec AS COM_CTSEC,
	       A.com_scd   AS COM_SCD
	FROM   tc_stinf A WITH (nolock),
	       tt_comcd B WITH (nolock)
	WHERE  A.com_scd = B.ccd_cd
	       AND A.sti_cd IN (SELECT DISTINCT k_sti_cd
	                        FROM   tc_stinf S WITH (nolock)
	                        WHERE  S.com_scd = #{com_scd}
	                        	   AND S.sti_rank = 'Y'
	                        	   AND S.real_yn = 'Y')
	       AND A.sti_rank = 'Y'
	       AND A.real_yn = 'Y'
	       AND B.cdx_cd = 'C16'
	       AND B.ccd_yn = 'Y'
	ORDER  BY A.sti_nm,
	          A.sti_cd       
]]>
</select>
<select id="selectScheduleMainList" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPScheduleList">         
<![CDATA[ 
	SELECT
		'시공'   AS COM_SSEC,
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.COM_BRAND ) AS COM_BRAND,
		A.REM_DT AS REM_DT,
		A.REM_SEQ AS REM_SEQ,
		A.PLM_NO AS PLM_NO,
		A.ORM_NO AS ORM_NO,
		A.REM_PTM AS PLM_PTM,
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.REM_PTM ) AS PLM_PTMNM,
		A.REM_FTM AS REM_FTM,
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.REM_FTM ) AS REM_FTMNM,
		A.ORM_NM AS ORM_NM,
		( SELECT ISNULL(TOO.ORM_GADDR, '' ) + ISNULL(TOO.ADDR_DTL , '' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) AS ORM_GADDR,
		( SELECT ISNULL(TOO.ORM_HDPHONE, '' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) AS ORM_HDPHONE,
		( CASE A.COM_BRAND WHEN 'T60I02' THEN ( SELECT SUM(CC.IOP_SALCST*BB.ORD_QTY)
												  FROM TO_ORDMAS AA WITH (NOLOCK), TO_ORDDET BB WITH (NOLOCK), TT_ITMCOP CC WITH (NOLOCK)
											     WHERE AA.ORM_NO = BB.ORM_NO
												   AND AA.ORM_NO = A.ORM_NO
												   AND BB.ITM_CD = CC.ITM_CD
												   AND BB.COL_CD = CC.COL_CD
												   AND CC.COM_CMP = AA.VND_CD )
						   ELSE  CASE A.ORM_AMT  WHEN  0 THEN (SELECT SUM(TCP.PLD_FAMT) FROM TC_PLANDTL TCP WITH (NOLOCK) WHERE TCP.PLM_NO = A.PLM_NO )
													     ELSE  A.ORM_AMT END END ) AS ORD_AMT,
		( CASE LEFT(A.ORM_NM, 5) WHEN '(벽고정)' THEN  'Y' ELSE 'N' END ) AS 'WALLFIX_YN',
		( SELECT ISNULL(TOO.ORM_GGUBUN, 'N' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) AS ORM_GGUBUN,
		(CASE WHEN (SELECT COUNT(*) 
		              FROM TO_ORDDET IA WITH (NOLOCK), TC_IMPO IB WITH (NOLOCK)
					 WHERE IA.ORM_NO=A.ORM_NO 
					   AND IA.ITM_CD=IB.ITM_CD 
					   AND A.COM_BRAND=IB.COM_BRAND 
					   AND A.COM_AGSEC=IB.COM_AGSEC 
					   AND IA.COL_CD=IB.COL_CD) = '0' THEN 'N' ELSE 'Y' END) AS CANNOT_ONE /* 1인불가 */,
		( SELECT ISNULL(TOO.LDDR_YN, 'N' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) AS LDDR_YN,
		( SELECT ISNULL(TOO.PLM_ITR, 'N' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) AS PLM_ITR,
		( SELECT ISNULL(TOO.PLM_EVT, 'N' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) AS PLM_EVT,
		( CASE WHEN ( SELECT COUNT(*)
						FROM TC_PLANDTL TCP WITH (NOLOCK)
					   WHERE TCP.PLM_NO = A.PLM_NO 
					     AND TCP.COM_PLDSEC = 'C09A' ) > 0 THEN 'Y' ELSE 'N' END ) AS 'TRASH_YN',
		( CASE WHEN ( SELECT COUNT(*) 
		                FROM TC_SCHEDULE TRS WITH (NOLOCK)
					   WHERE TRS.ORM_NO = A.ORM_NO
					     AND TRS.REM_DT = A.REM_DT )  > 0 THEN 'Y' ELSE 'N' END ) AS 'TRANS_YN',
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = ( SELECT ISNULL(TCP.COM_RMFG, 'C13W') FROM TC_PLANMST TCP WITH (NOLOCK) WHERE A.PLM_NO = TCP.PLM_NO ) ) AS COM_RMFG	,
		( SELECT CASE LEN(ISNULL(TCP.PLM_PNO, '')) WHEN 0 THEN '' ELSE '재일정' END FROM TC_PLANMST TCP WITH (NOLOCK) WHERE A.PLM_NO = TCP.PLM_NO ) AS COM_RMFG_SUB,
		( SELECT TOP 1 CASE LEFT(ISNULL(TCD.COM_UNDSEC, ''), 4) WHEN 'C52A' THEN '(재)' WHEN 'C52B' THEN '(반)' WHEN 'C52C' THEN '(AS)' ELSE '' END  FROM TC_PLANMST TCP WITH (NOLOCK), TC_PLANDTL TCD WITH (NOLOCK) WHERE A.PLM_NO = TCP.PLM_NO AND A.PLM_NO = TCD.PLM_NO ) AS COM_RMFG_SUB2,
		A.REM_TMFYN AS REM_TMFYN,
		ISNULL(A.LATITUDE, '') AS LATITUDE, 
		ISNULL(A.LONGITUDE, '') AS LONGITUDE,
		CONVERT(INT, A.ARRIVAL_SEQ) AS ARRIVAL_SEQ,
		ISNULL(( SELECT SUM(TCA.ACL_AMT) FROM TC_ACTLIST TCA WITH (NOLOCK) WHERE TCA.PLM_NO = A.PLM_NO ), 0) AS PLD_SUM  	 
	FROM TC_RESMST A WITH (NOLOCK)
	WHERE A.COM_SCD = #{com_scd}	
	  AND A.STI_CD = #{sti_cd}	
	  AND A.REM_DT = #{date}
	  AND A.COM_SSEC = 'C18C'	
	UNION ALL
	SELECT
		'AS'   AS COM_SSEC,
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.COM_BRAND ) AS COM_BRAND,
		A.REM_DT AS REM_DT,
		A.REM_SEQ AS REM_SEQ,
		A.PLM_NO AS PLM_NO,
		A.ORM_NO AS ORM_NO,
		A.REM_PTM AS PLM_PTM,
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.REM_PTM ) AS PLM_PTMNM,
		A.REM_FTM AS REM_FTM,
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.REM_FTM ) AS REM_FTMNM,
		A.ORM_NM AS ORM_NM,
		( SELECT ISNULL(B.CTM_ADDR, '') + ISNULL(B.CTM_ADDR2, '')
			 FROM TA_RPTREQ B WITH (NOLOCK)
         WHERE SUBSTRING(A.ORM_NO, 1, 13) = B.RPT_NO 
			  AND SUBSTRING(A.ORM_NO, 14, 15) = B.RPT_SEQ ) AS ORM_GADDR,
		( SELECT ISNULL(B.CTM_HP, '') 
			 FROM TA_RPTREQ B WITH (NOLOCK)
         WHERE SUBSTRING(A.ORM_NO, 1, 13) = B.RPT_NO 
			  AND SUBSTRING(A.ORM_NO, 14, 15) = B.RPT_SEQ ) AS ORM_HDPHONE,
		( SELECT SUM(TAA.AST_QQTY * TAA.BMT_SAMT)
		    FROM TA_ASTITEM TAA WITH (NOLOCK), TA_RPTREQ B WITH(NOLOCK)
		   WHERE TAA.RPT_NO = B.RPT_NO
		     AND TAA.RPT_SEQ = B.RPT_SEQ
			  AND SUBSTRING(A.ORM_NO, 1, 13) = B.RPT_NO 
			  AND SUBSTRING(A.ORM_NO, 14, 15) = B.RPT_SEQ ) AS ORD_AMT,
		( SELECT ( CASE LEFT(B.CTM_NM, 5) WHEN '(벽고정)' THEN  'Y' ELSE 'N' END )
			 FROM TA_RPTREQ B WITH (NOLOCK)
         WHERE SUBSTRING(A.ORM_NO, 1, 13) = B.RPT_NO 
			  AND SUBSTRING(A.ORM_NO, 14, 15) = B.RPT_SEQ ) AS WALLFIX_YN,
		'N' AS 'ORM_GGUBUN',
		'N' AS CANNOT_ONE /* 1인불가 */,
		'N' AS LDDR_YN,
		'N' AS PLM_ITR,
		'N' AS PLM_EVT,
		'N' AS 'TRASH_YN',
		'N' AS 'TRANS_YN',		
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = ( SELECT TOP 1 ( CASE TCP.COM_RDSEC  WHEN   '' THEN 'C13W' WHEN   NULL THEN 'C13W' ELSE TCP.COM_RDSEC END) FROM TA_PLANDTL TCP WITH (NOLOCK) WHERE A.PLM_NO = TCP.PLM_NO ) ) AS COM_RMFG,
		'' AS COM_RMFG_SUB,
		'' AS COM_RMFG_SUB2,
		'' AS REM_TMFYN,
		ISNULL(A.LATITUDE, '') AS LATITUDE, 
		ISNULL(A.LONGITUDE, '') AS LONGITUDE,
		CONVERT(INT, A.ARRIVAL_SEQ) AS ARRIVAL_SEQ,
		0 AS PLD_SUM
	FROM TC_RESMST A WITH (NOLOCK)
	LEFT OUTER JOIN TA_PLANMST BB WITH (NOLOCK) ON A.PLM_NO = BB.PLM_NO AND A.REM_ASNO = BB.RPT_SEQ AND SUBSTRING(A.ORM_NO, 1, 13) = BB.RPT_NO 
	WHERE A.COM_SCD = #{com_scd}
	  AND A.STI_CD = #{sti_cd}	
	  AND A.REM_DT = #{date}
	  AND A.COM_SSEC = 'C18A'
	  /* AND (SELECT COUNT(1) FROM TA_PLANDTL TP WHERE TP.PLM_NO = A.PLM_NO ) > 0 */
	ORDER BY CONVERT(INT, A.ARRIVAL_SEQ), REM_FTMNM

]]>
</select> 
 
<select id="selectScheduleMainList_" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPScheduleList">         
<![CDATA[ 
	SELECT
		'시공'   AS COM_SSEC,
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.COM_BRAND ) AS COM_BRAND,
		A.REM_DT AS REM_DT,
		A.REM_SEQ AS REM_SEQ,
		A.PLM_NO AS PLM_NO,
		A.ORM_NO AS ORM_NO,
		A.REM_PTM AS PLM_PTM,
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.REM_PTM ) AS PLM_PTMNM,
		A.REM_FTM AS REM_FTM,
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.REM_FTM ) AS REM_FTMNM,
		A.ORM_NM AS ORM_NM,
		( SELECT ISNULL(TOO.ORM_GADDR, '' ) + ISNULL(TOO.ADDR_DTL , '' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) AS ORM_GADDR,
		( SELECT ISNULL(TOO.ORM_HDPHONE, '' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) AS ORM_HDPHONE,
		( CASE A.COM_BRAND WHEN 'T60I02' THEN ( SELECT SUM(CC.IOP_SALCST*BB.ORD_QTY)
												  FROM TO_ORDMAS AA WITH (NOLOCK), TO_ORDDET BB WITH (NOLOCK), TT_ITMCOP CC WITH (NOLOCK)
											     WHERE AA.ORM_NO = BB.ORM_NO
												   AND AA.ORM_NO = A.ORM_NO
												   AND BB.ITM_CD = CC.ITM_CD
												   AND BB.COL_CD = CC.COL_CD
												   AND CC.COM_CMP = AA.VND_CD )
						   ELSE  CASE A.ORM_AMT  WHEN  0 THEN (SELECT SUM(TCP.PLD_FAMT) FROM TC_PLANDTL TCP WITH (NOLOCK) WHERE TCP.PLM_NO = A.PLM_NO )
													     ELSE  A.ORM_AMT END END ) AS ORD_AMT,
		( CASE LEFT(A.ORM_NM, 5) WHEN '(벽고정)' THEN  'Y' ELSE 'N' END ) AS 'WALLFIX_YN',
		( SELECT ISNULL(TOO.ORM_GGUBUN, 'N' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) AS ORM_GGUBUN,
		(CASE WHEN (SELECT COUNT(*) 
		              FROM TO_ORDDET IA WITH (NOLOCK), TC_IMPO IB WITH (NOLOCK)
					 WHERE IA.ORM_NO=A.ORM_NO 
					   AND IA.ITM_CD=IB.ITM_CD 
					   AND A.COM_BRAND=IB.COM_BRAND 
					   AND A.COM_AGSEC=IB.COM_AGSEC 
					   AND IA.COL_CD=IB.COL_CD) = '0' THEN 'N' ELSE 'Y' END) AS CANNOT_ONE /* 1인불가 */,
		( SELECT ISNULL(TOO.LDDR_YN, 'N' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) AS LDDR_YN,
		( SELECT ISNULL(TOO.PLM_ITR, 'N' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) AS PLM_ITR,
		( SELECT ISNULL(TOO.PLM_EVT, 'N' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) AS PLM_EVT,
		( CASE WHEN ( SELECT COUNT(*)
						FROM TC_PLANDTL TCP WITH (NOLOCK)
					   WHERE TCP.PLM_NO = A.PLM_NO 
					     AND TCP.COM_PLDSEC = 'C09A' ) > 0 THEN 'Y' ELSE 'N' END ) AS 'TRASH_YN',
		( CASE WHEN ( SELECT COUNT(*) 
		                FROM TC_SCHEDULE TRS WITH (NOLOCK)
					   WHERE TRS.ORM_NO = A.ORM_NO
					     AND TRS.REM_DT = A.REM_DT )  > 0 THEN 'Y' ELSE 'N' END ) AS 'TRANS_YN',
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = ( SELECT ISNULL(TCP.COM_RMFG, 'C13W') FROM TC_PLANMST TCP WITH (NOLOCK) WHERE A.PLM_NO = TCP.PLM_NO ) ) AS COM_RMFG	,
		A.REM_TMFYN AS REM_TMFYN,
		ISNULL(A.LATITUDE, '') AS LATITUDE, 
		ISNULL(A.LONGITUDE, '') AS LONGITUDE,
		CONVERT(INT, A.ARRIVAL_SEQ) AS ARRIVAL_SEQ,
		ISNULL(( SELECT SUM(TCA.ACL_AMT) FROM TC_ACTLIST TCA WITH (NOLOCK) WHERE TCA.PLM_NO = A.PLM_NO ), 0) AS PLD_SUM  	 
	FROM TC_RESMST A WITH (NOLOCK)
	WHERE A.COM_SCD = #{com_scd}	
	  AND A.STI_CD = #{sti_cd}	
	  AND A.REM_DT = #{date}
	  AND A.COM_SSEC = 'C18C'	
	UNION ALL
	SELECT
		'AS'   AS COM_SSEC,
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.COM_BRAND ) AS COM_BRAND,
		A.REM_DT AS REM_DT,
		A.REM_SEQ AS REM_SEQ,
		A.PLM_NO AS PLM_NO,
		A.ORM_NO AS ORM_NO,
		A.REM_PTM AS PLM_PTM,
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.REM_PTM ) AS PLM_PTMNM,
		A.REM_FTM AS REM_FTM,
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.REM_FTM ) AS REM_FTMNM,
		A.ORM_NM AS ORM_NM,
		( SELECT ISNULL(B.CTM_ADDR, '') + ISNULL(B.CTM_ADDR2, '')
			 FROM TA_RPTREQ B WITH (NOLOCK)
         WHERE SUBSTRING(A.ORM_NO, 1, 13) = B.RPT_NO 
			  AND SUBSTRING(A.ORM_NO, 14, 15) = B.RPT_SEQ ) AS ORM_GADDR,
		( SELECT ISNULL(B.CTM_HP, '') 
			 FROM TA_RPTREQ B WITH (NOLOCK)
         WHERE SUBSTRING(A.ORM_NO, 1, 13) = B.RPT_NO 
			  AND SUBSTRING(A.ORM_NO, 14, 15) = B.RPT_SEQ ) AS ORM_HDPHONE,
		( SELECT SUM(TAA.AST_QQTY * TAA.BMT_SAMT)
		    FROM TA_ASTITEM TAA WITH (NOLOCK), TA_RPTREQ B WITH(NOLOCK)
		   WHERE TAA.RPT_NO = B.RPT_NO
		     AND TAA.RPT_SEQ = B.RPT_SEQ
			  AND SUBSTRING(A.ORM_NO, 1, 13) = B.RPT_NO 
			  AND SUBSTRING(A.ORM_NO, 14, 15) = B.RPT_SEQ ) AS ORD_AMT,
		( SELECT ( CASE LEFT(B.CTM_NM, 5) WHEN '(벽고정)' THEN  'Y' ELSE 'N' END )
			 FROM TA_RPTREQ B WITH (NOLOCK)
         WHERE SUBSTRING(A.ORM_NO, 1, 13) = B.RPT_NO 
			  AND SUBSTRING(A.ORM_NO, 14, 15) = B.RPT_SEQ ) AS WALLFIX_YN,
		'N' AS 'ORM_GGUBUN',
		'N' AS CANNOT_ONE /* 1인불가 */,
		'N' AS LDDR_YN,
		'N' AS PLM_ITR,
		'N' AS PLM_EVT,
		'N' AS 'TRASH_YN',
		'N' AS 'TRANS_YN',
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = ( SELECT TOP 1 ( CASE TCP.COM_RDSEC  WHEN   '' THEN 'C13W' 
						        																		  WHEN   NULL THEN 'C13W' 
								  													   ELSE TCP.COM_RDSEC END) FROM TA_PLANDTL TCP WITH (NOLOCK) WHERE A.PLM_NO = TCP.PLM_NO ) ) AS COM_RMFG,
        '' AS REM_TMFYN,
		ISNULL(A.LATITUDE, '') AS LATITUDE, 
		ISNULL(A.LONGITUDE, '') AS LONGITUDE,
		CONVERT(INT, A.ARRIVAL_SEQ) AS ARRIVAL_SEQ,
		0 AS PLD_SUM
	FROM TC_RESMST A WITH (NOLOCK)
	LEFT OUTER JOIN TA_PLANMST BB WITH (NOLOCK) ON A.PLM_NO = BB.PLM_NO AND A.REM_ASNO = BB.RPT_SEQ AND SUBSTRING(A.ORM_NO, 1, 13) = BB.RPT_NO 
	WHERE A.COM_SCD = #{com_scd}
	  AND A.STI_CD = #{sti_cd}	
	  AND A.REM_DT = #{date}
	  AND A.COM_SSEC = 'C18A'
	  /* AND (SELECT COUNT(1) FROM TA_PLANDTL TP WHERE TP.PLM_NO = A.PLM_NO ) > 0 */
	ORDER BY CONVERT(INT, A.ARRIVAL_SEQ), REM_FTMNM

]]>
</select> 

<select id="selectSigongMainPage" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPConstructionMainPage">         
<![CDATA[ 
	SELECT
		'시공'   AS COM_SSEC,
		A.COM_SSEC AS COM_SSEC_CD,
		(SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.COM_SSEC ) AS COM_SSEC_NM,
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.COM_BRAND ) AS COM_BRAND,
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.COM_BRAND ) AS COM_BRAND_NM,
		A.COM_BRAND AS COM_BRAND_CD,
		A.PLM_NO AS PLM_NO,
		A.ORM_NO AS ORM_NO,
		A.ORM_NM AS ORM_NM,
		( SELECT ISNULL(TOO.ORM_GADDR, '' ) + ' ' + ISNULL(TOO.ADDR_DTL, '' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO )  AS ORM_GADDR,
		A.AGT_CD AS AGT_CD,
		( SELECT TTV.VND_NM FROM TT_VENDOR TTV WITH (NOLOCK) WHERE TTV.VND_CD = A.AGT_CD) AS AGT_NM,
		( SELECT ISNULL(TTV.VND_TELNO, '') FROM TT_VENDOR TTV WITH (NOLOCK) WHERE TTV.VND_CD = A.AGT_CD) AS VND_TELNO,
		ISNULL(A.REM_RMK, '') AS REM_RMK,	
		( SELECT ISNULL(TOO.ORM_GSPC, '' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) AS REM_RMK2,	
		( SELECT ISNULL(TOO.ORM_GEMPHP, '' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) AS ORM_GEMPTEL,
		( SELECT ISNULL(TOO.ORM_HDPHONE, '' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) AS ORM_HDPHONE,
		( CASE LEFT(A.ORM_NM, 5) WHEN '(벽고정)' THEN  'Y' ELSE 'N' END ) AS 'WALLFIX_YN',
		( SELECT ISNULL(TOO.ORM_GGUBUN, 'N' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) AS ORM_GGUBUN,
		( SELECT ISNULL(TOO.LDDR_YN, 'N' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) AS LDDR_YN,
		( SELECT ISNULL(TOO.PLM_ITR, 'N' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) AS PLM_ITR,
		( SELECT ISNULL(TOO.PLM_EVT, 'N' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) AS PLM_EVT,
		( CASE WHEN ( SELECT COUNT(*)
						FROM TC_PLANDTL TCP
					   WHERE TCP.PLM_NO = A.PLM_NO 
					     AND TCP.COM_PLDSEC = 'C09A' ) > 0 THEN 'Y' ELSE 'N' END ) AS 'TRASH_YN',
		( CASE WHEN ( SELECT COUNT(*) 
		                FROM TC_SCHEDULE TRS WITH (NOLOCK)
					   WHERE TRS.ORM_NO = A.ORM_NO
					     AND TRS.REM_DT = A.REM_DT )  > 0 THEN 'Y' ELSE 'N' END ) AS 'TRANS_YN',
		(CASE WHEN (SELECT COUNT(*) 
		              FROM TO_ORDDET IA WITH (NOLOCK), TC_IMPO IB WITH (NOLOCK)
					 WHERE IA.ORM_NO=A.ORM_NO 
					   AND IA.ITM_CD=IB.ITM_CD 
					   AND A.COM_BRAND=IB.COM_BRAND 
					   AND A.COM_AGSEC=IB.COM_AGSEC 
					   AND IA.COL_CD=IB.COL_CD) = '0' THEN 'N' ELSE 'Y' END) AS CANNOT_ONE /* 1인불가 */,
		A.ORM_NO AS FILE_ID,
		( CASE WHEN (SELECT COUNT(*) 
		   			 FROM TC_RESMST TCR WITH (NOLOCK)
		  			WHERE TCR.ORM_NO = A.ORM_NO
		    		  AND TCR.COM_SSEC = 'C18C' ) > 1 THEN 'Y' ELSE 'N' END ) AS REM_CSEC,
		CASE WHEN ( SELECT ISNULL(TAP.MOB_STARTYN, 'N') FROM TC_PLANMST TAP WITH (NOLOCK) WHERE TAP.PLM_NO = A.PLM_NO AND TAP.PLM_CDT = A.REM_DT ) = 'N' THEN 'N'
			 WHEN ( SELECT ISNULL(TAP.MOB_STARTYN, 'N') FROM TC_PLANMST TAP WITH (NOLOCK) WHERE TAP.PLM_NO = A.PLM_NO AND TAP.PLM_CDT = A.REM_DT ) = 'Y' THEN 'Y' 
			 ELSE 'N' END AS START_YN,
		CASE WHEN ( SELECT ISNULL(TAP.MOB_ENDYN, 'N') FROM TC_PLANMST TAP WITH (NOLOCK) WHERE TAP.PLM_NO = A.PLM_NO AND TAP.PLM_CDT = A.REM_DT ) = 'N' THEN 'N'
			 WHEN ( SELECT ISNULL(TAP.MOB_ENDYN, 'Y') FROM TC_PLANMST TAP WITH (NOLOCK) WHERE TAP.PLM_NO = A.PLM_NO AND TAP.PLM_CDT = A.REM_DT ) = 'Y' THEN 'Y' 
			 ELSE 'N' END AS END_YN,
		A.COM_AGSEC AS COM_AGSEC,
		A.REM_DT AS REM_DT,
		A.REM_SEQ AS REM_SEQ,
		( CASE WHEN ( SELECT COUNT(*) 
		              FROM TW_WTRECPL TWW WITH (NOLOCK) 
		              WHERE TWW.ORM_NO = A.ORM_NO ) > 0 THEN 'Y' ELSE 'N' END ) AS BANPUM_YN,
		( SELECT ISNULL(TCS.STI_NM, '') FROM TC_STINF TCS WITH (NOLOCK) WHERE TCS.COM_SCD = A.COM_SCD AND TCS.STI_CD = A.STI_CD ) AS STI_NM,
		A.STI_CD,
		( SELECT TCS.COM_STSEC FROM TC_STINF TCS WITH (NOLOCK) WHERE TCS.STI_CD = A.STI_CD AND TCS.COM_SCD = A.COM_SCD ) AS COM_STSEC,
		A.COM_RFG AS COM_RFG,
		( SELECT TTV.VND_ADDR FROM TT_VENDOR TTV WITH (NOLOCK) WHERE TTV.VND_CD = A.COM_SCD ) AS VND_ADDR,
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.REM_PTM ) AS PLM_PTMNM,
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.REM_FTM ) AS REM_FTMNM,
		( SELECT TT.CCD_NAME FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.REM_FTM ) AS REM_FTMNAME,
		A.REM_FTM AS REM_FTM,
		ISNULL(( SELECT TSC.CEP_NM FROM TS_CEMPLOYEE TSC WITH (NOLOCK) WHERE TSC.CEP_CD = ( SELECT TOO.ORM_AGTEMP  FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) ), '') AS CEP_NM,
		ISNULL(( SELECT TSC.CEP_MP FROM TS_CEMPLOYEE TSC WITH (NOLOCK) WHERE TSC.CEP_CD = ( SELECT TOO.ORM_AGTEMP  FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) ), '') AS CEP_MP,
		ISNULL(A.STM_NO, '') AS STM_NO,
		ISNULL(( SELECT TCM.STM_NM FROM TC_STMEMBER TCM WITH (NOLOCK) WHERE TCM.COM_SCD = A.COM_SCD AND TCM.STI_CD = A.STI_CD AND TCM.STM_NO = A.STM_NO ), '') AS STM_NM,
		( CASE A.COM_BRAND WHEN 'T60I02' THEN ( SELECT SUM(CC.IOP_SALCST*BB.ORD_QTY)
														  FROM TO_ORDMAS AA WITH (NOLOCK), TO_ORDDET BB WITH (NOLOCK), TT_ITMCOP CC WITH (NOLOCK)
													     WHERE AA.ORM_NO = BB.ORM_NO
														   AND AA.ORM_NO = A.ORM_NO
														   AND BB.ITM_CD = CC.ITM_CD
														   AND BB.COL_CD = CC.COL_CD
														   AND CC.COM_CMP = AA.VND_CD )
								   ELSE  A.ORM_AMT END ) AS ORD_AMT,
		ISNULL(( SELECT SUM(TCA.ACL_AMT) FROM TC_ACTLIST TCA WITH (NOLOCK) WHERE TCA.PLM_NO = A.PLM_NO ), 0) AS PLD_SUM,
		A.REQ_TIME, A.REQ_LOCATION
	FROM TC_RESMST A WITH (NOLOCK)
	WHERE A.REM_DT = #{rem_dt}
	  AND A.REM_SEQ = #{rem_seq}
]]>
</select>
  
<select id="selectSigongItemPage" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPConstructionItemPage">         
<![CDATA[ 
	SELECT
		(SELECT TTI.ITM_NM FROM TT_ITMMST TTI WITH (NOLOCK) WHERE TTI.ITM_CD = A.ITM_CD AND TTI.COL_CD = A.COL_CD ) AS ITM_NM,
		A.ITM_CD + '-' + A.COL_CD AS 'ITMCD_COL',
		ISNULL(A.SET_CD, '') + '-' + ISNULL(A.COL_SCD, '')AS 'SETCD_COL',
		SUM(A.PLD_FQTY) AS PLD_FQTY,
		( CASE LEFT(A.PLM_NO, 1) WHEN 'F' THEN ( CASE (SELECT TOO.ORM_GGUBUN
		                                                FROM TC_PLANMST TCP WITH (NOLOCK), TO_ORDMAS TOO WITH (NOLOCK)
													   WHERE TCP.PLM_NO = A.PLM_NO 
													     AND TCP.ORM_NO = TOO.ORM_NO)														
													WHEN 'Y' THEN SUM(A.PLD_FQTY*ISNULL(C.ITM_CONSTCST, 0))  ELSE ROUND(SUM(A.PLD_FQTY*ISNULL(C.ITM_CONSTCST, 0)) * 1.37, 0) END )
							     WHEN 'P' THEN ( CASE (SELECT TOO.ORM_GGUBUN
		                                                FROM TC_PLANMST TCP WITH (NOLOCK), TO_ORDMAS TOO WITH (NOLOCK)
													   WHERE TCP.PLM_NO = A.PLM_NO 
													     AND TCP.ORM_NO = TOO.ORM_NO)														
													WHEN 'Y' THEN SUM(A.PLD_FQTY*ISNULL(C.ITM_CONSTCST, 0)) ELSE ROUND(SUM(A.PLD_FQTY*ISNULL(C.ITM_CONSTCST, 0)) * 1.37, 0) END )
							   ELSE SUM(A.PLD_FQTY*ISNULL(C.ITM_CONSTCST, 0)) END ) AS PLD_SUM
      FROM TC_PLANDTL A WITH (NOLOCK), TT_ITMCOP C WITH (NOLOCK)
     WHERE A.PLM_NO = #{plm_no}
       AND A.COM_PLDSEC = 'C090'
       AND A.PLD_FQTY <> 0
	   AND C.ITM_CD = A.ITM_CD
       AND C.COL_CD = A.COL_CD
 	   AND C.COM_CMP = 'T01'+ LEFT(A.PLM_NO, 1 ) 
     GROUP BY A.SET_CD, A.COL_SCD, A.PLM_NO, A.ITM_CD, A.COL_CD
	 ORDER BY A.SET_CD, A.COL_SCD
]]>
</select>


<select id="selectSigongGitaItemPage" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPConstructionItemPage">         
<![CDATA[ 

	SELECT
		AA.PLD_SSEC AS 'PLD_SSEC',
		AA.ITM_NM AS 'ITM_NM',
		AA.ITMCD_COL AS 'ITMCD_COL',
		AA.SETCD_COL AS 'SETCD_COL',
		AA.PLD_FQTY AS 'PLD_FQTY',
		( CASE LEFT(AA.PLM_NO, 1) WHEN 'F' THEN 
												 ( CASE (SELECT TOO.ORM_GGUBUN
														   FROM TC_PLANMST TCP WITH (NOLOCK), TO_ORDMAS TOO WITH (NOLOCK)
														  WHERE TCP.PLM_NO = AA.PLM_NO 
														    AND TCP.ORM_NO = TOO.ORM_NO)														
												           WHEN 'Y' THEN AA.PLD_SUM ELSE ROUND(AA.PLD_SUM * 1.37, 0) END ) 		
								WHEN 'p' THEN 
												 ( CASE (SELECT TOO.ORM_GGUBUN
														   FROM TC_PLANMST TCP WITH (NOLOCK), TO_ORDMAS TOO WITH (NOLOCK)
														  WHERE TCP.PLM_NO = AA.PLM_NO 
														    AND TCP.ORM_NO = TOO.ORM_NO)														
												           WHEN 'Y' THEN AA.PLD_SUM ELSE ROUND(AA.PLD_SUM * 1.37, 0) END )
								ELSE AA.PLD_SUM END  )AS PLD_SUM
	FROM ( 
			SELECT
				'매장경유' AS 'PLD_SSEC',
				(SELECT TTI.ITM_NM FROM TT_ITMMST TTI WITH (NOLOCK) WHERE TTI.ITM_CD = A.ITM_CD AND TTI.COL_CD = A.COL_CD ) AS ITM_NM,
				A.ITM_CD + '-' + A.COL_CD AS 'ITMCD_COL',
				ISNULL(A.SET_CD, '') + '-' + ISNULL(A.COL_SCD, '') AS 'SETCD_COL',
				SUM(A.PLD_FQTY) AS PLD_FQTY,
				 (CASE WHEN (A.COM_UNDSEC = 'C52B02' or A.COM_UNDSEC = 'C52C01' or A.COM_UNDSEC = 'C52C02') THEN  ISNULL((SELECT ISNULL(A.PLD_EQTY,0) * ISNULL(DD.ITM_CONSTCST,0) FROM TT_ITMCOP DD WITH (NOLOCK)
																						   WHERE 1=1
																							 AND A.ITM_CD = DD.ITM_CD
																							 AND A.COL_CD = DD.COL_CD
																							 AND DD.COM_CMP = (SELECT COM_CMP FROM [dbo].[TT_COMCD] WITH (NOLOCK)
																								   							 WHERE CDX_CD = 'C02' AND CCD_CD = 'C02'+CAST( LEFT(A.PLM_NO, 1) AS VARCHAR))		  
						   ),0)
																							ELSE  ISNULL((SELECT ISNULL(A.PLD_FQTY,0) * ISNULL(DD.ITM_CONSTCST,0) FROM TT_ITMCOP DD WITH (NOLOCK)
																						   WHERE 1=1
																							 AND A.ITM_CD = DD.ITM_CD
																							 AND A.COL_CD = DD.COL_CD
																							 AND DD.COM_CMP = (SELECT COM_CMP FROM [dbo].[TT_COMCD] WITH (NOLOCK)
																								   							 WHERE CDX_CD = 'C02' AND CCD_CD = 'C02'+CAST( LEFT(A.PLM_NO, 1) AS VARCHAR))		  
						   ),0) END) AS PLD_SUM,
				A.PLM_NO AS PLM_NO									
			  FROM TC_PLANDTL A WITH (NOLOCK)
			 WHERE A.PLM_NO = #{plm_no}
			   AND A.COM_PLDSEC = 'C092'
		  GROUP BY A.ITM_CD, A.COL_CD, A.SET_CD, A.COL_SCD, A.PLD_EQTY, COM_UNDSEC, A.PLD_FQTY, A.PLM_NO ) AA

    UNION ALL
    
	SELECT
		'분해설치' AS 'PLD_SSEC',
		(SELECT MAX(TCR.TRI_INM) FROM TC_TRINF TCR WITH (NOLOCK) WHERE TCR.TRI_ICD = A.ITM_CD AND TCR.COM_AGSEC = B.COM_AGSEC AND TCR.COM_BRAND = B.COM_BRAND AND TCR.TRS_SEC = A.trs_sec_2 ) AS ITM_NM,
		A.ITM_CD AS 'ITMCD_COL',
		A.ITM_CD AS 'SETCD_COL',
		A.PLD_FQTY AS PLD_FQTY,
		ISNULL(A.PLD_CFAMT , 0) AS PLD_SUM
	  FROM TC_PLANDTL A WITH (NOLOCK), TC_PLANMST B WITH (NOLOCK)
	 WHERE A.PLM_NO = #{plm_no}
	   AND A.COM_PLDSEC = 'C094'
	   AND A.PLM_NO = B.PLM_NO

    UNION ALL

	SELECT
		'폐기장' AS 'PLD_SSEC',
		(SELECT TCR.TRI_INM FROM TC_TRINF TCR WITH (NOLOCK) WHERE TCR.TRI_ICD = A.ITM_CD AND TCR.COM_AGSEC = B.COM_AGSEC AND TCR.COM_BRAND = B.COM_BRAND AND TCR.TRS_SEC = A.trs_sec_2 ) AS ITM_NM,
		A.ITM_CD AS 'ITMCD_COL',
		A.ITM_CD AS 'SETCD_COL',
		A.PLD_FQTY AS PLD_FQTY,
		ISNULL(A.PLD_CFAMT , 0) AS PLD_SUM	  
	  FROM TC_PLANDTL A WITH (NOLOCK), TC_PLANMST B WITH (NOLOCK)
	 WHERE A.PLM_NO = #{plm_no}
	   AND A.COM_PLDSEC = 'C09A'
	   AND A.PLM_NO = B.PLM_NO

    UNION ALL

	SELECT
		AA.PLD_SSEC AS 'PLD_SSEC',
		AA.ITM_NM AS 'ITM_NM',
		AA.ITMCD_COL AS 'ITMCD_COL',
		AA.SETCD_COL AS 'SETCD_COL',
		AA.PLD_FQTY AS 'PLD_FQTY',
		( CASE LEFT(AA.PLM_NO, 1) WHEN 'F' THEN 
												 ( CASE (SELECT TOO.ORM_GGUBUN
														   FROM TC_PLANMST TCP WITH (NOLOCK), TO_ORDMAS TOO WITH (NOLOCK)
														  WHERE TCP.PLM_NO = AA.PLM_NO 
														    AND TCP.ORM_NO = TOO.ORM_NO)														
												           WHEN 'Y' THEN AA.PLD_SUM ELSE ROUND(AA.PLD_SUM * 1.37, 0) END ) 		
								WHEN 'p' THEN 
												 ( CASE (SELECT TOO.ORM_GGUBUN
														   FROM TC_PLANMST TCP WITH (NOLOCK), TO_ORDMAS TOO WITH (NOLOCK)
														  WHERE TCP.PLM_NO = AA.PLM_NO 
														    AND TCP.ORM_NO = TOO.ORM_NO)														
												           WHEN 'Y' THEN AA.PLD_SUM ELSE ROUND(AA.PLD_SUM * 1.37, 0) END )
								ELSE AA.PLD_SUM END  )AS PLD_SUM   
	  FROM ( 
			SELECT
				'반품회수' AS 'PLD_SSEC',
				(SELECT TTI.ITM_NM FROM TT_ITMMST TTI WITH (NOLOCK) WHERE TTI.ITM_CD = A.ITM_CD AND TTI.COL_CD = A.COL_CD ) AS ITM_NM,
				A.ITM_CD + '-' + A.COL_CD AS 'ITMCD_COL',
				ISNULL(A.SET_CD, '') + '-' + ISNULL(A.COL_SCD, '') AS 'SETCD_COL',
				SUM(A.PLD_FQTY) AS PLD_FQTY,
				 (CASE WHEN (A.COM_UNDSEC = 'C52B02' or A.COM_UNDSEC = 'C52C01' or A.COM_UNDSEC = 'C52C02') THEN  ISNULL((SELECT ISNULL(A.PLD_EQTY,0) * ISNULL(DD.ITM_CONSTCST,0) FROM TT_ITMCOP DD WITH (NOLOCK)
																						   WHERE 1=1
																							 AND A.ITM_CD = DD.ITM_CD
																							 AND A.COL_CD = DD.COL_CD
																							 AND DD.COM_CMP = (SELECT COM_CMP FROM [dbo].[TT_COMCD] WITH (NOLOCK)
																								   							 WHERE CDX_CD = 'C02' AND CCD_CD = 'C02'+CAST( LEFT(A.PLM_NO, 1) AS VARCHAR))		  
						   ),0)
																							ELSE  ISNULL((SELECT ISNULL(A.PLD_FQTY,0) * ISNULL(DD.ITM_CONSTCST,0) FROM TT_ITMCOP DD WITH (NOLOCK)
																						   WHERE 1=1
																							 AND A.ITM_CD = DD.ITM_CD
																							 AND A.COL_CD = DD.COL_CD
																							 AND DD.COM_CMP = (SELECT COM_CMP FROM [dbo].[TT_COMCD] WITH (NOLOCK)
																								   							 WHERE CDX_CD = 'C02' AND CCD_CD = 'C02'+CAST( LEFT(A.PLM_NO, 1) AS VARCHAR))		  
						   ),0) END) AS PLD_SUM,
				A.PLM_NO AS PLM_NO	
			  FROM TC_PLANDTL A WITH (NOLOCK)
			 WHERE A.PLM_NO = #{plm_no}
			   AND A.COM_PLDSEC = 'C096'
			 GROUP BY A.ITM_CD, A.COL_CD, A.SET_CD, A.COL_SCD, A.PLD_EQTY, COM_UNDSEC, A.PLD_FQTY, A.PLM_NO ) AA

]]>
</select>

<select id="selectSigongGitaItemPage_backup" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPConstructionItemPage">         
<![CDATA[ 

	SELECT
		AA.PLD_SSEC AS 'PLD_SSEC',
		AA.ITM_NM AS 'ITM_NM',
		AA.ITMCD_COL AS 'ITMCD_COL',
		AA.SETCD_COL AS 'SETCD_COL',
		AA.PLD_FQTY AS 'PLD_FQTY',
		( CASE LEFT(AA.PLM_NO, 1) WHEN 'F' THEN ROUND(AA.PLD_SUM * 1.39, 0) 
								WHEN 'P' THEN ROUND(AA.PLD_SUM * 1.37, 0) 
								ELSE AA.PLD_SUM END  )AS PLD_SUM
	FROM ( 
			SELECT
				'매장경유' AS 'PLD_SSEC',
				(SELECT TTI.ITM_NM FROM TT_ITMMST TTI WITH (NOLOCK) WHERE TTI.ITM_CD = A.ITM_CD AND TTI.COL_CD = A.COL_CD ) AS ITM_NM,
				A.ITM_CD + '-' + A.COL_CD AS 'ITMCD_COL',
				ISNULL(A.SET_CD, '') + '-' + ISNULL(A.COL_SCD, '') AS 'SETCD_COL',
				SUM(A.PLD_FQTY) AS PLD_FQTY,
				 (CASE WHEN (A.COM_UNDSEC = 'C52B02' or A.COM_UNDSEC = 'C52C01' or A.COM_UNDSEC = 'C52C02') THEN  ISNULL((SELECT ISNULL(A.PLD_EQTY,0) * ISNULL(DD.ITM_CONSTCST,0) FROM TT_ITMCOP DD WITH (NOLOCK)
																						   WHERE 1=1
																							 AND A.ITM_CD = DD.ITM_CD
																							 AND A.COL_CD = DD.COL_CD
																							 AND DD.COM_CMP = (SELECT COM_CMP FROM [dbo].[TT_COMCD] WITH (NOLOCK)
																								   							 WHERE CDX_CD = 'C02' AND CCD_CD = 'C02'+CAST( LEFT(A.PLM_NO, 1) AS VARCHAR))		  
						   ),0)
																							ELSE  ISNULL((SELECT ISNULL(A.PLD_FQTY,0) * ISNULL(DD.ITM_CONSTCST,0) FROM TT_ITMCOP DD WITH (NOLOCK)
																						   WHERE 1=1
																							 AND A.ITM_CD = DD.ITM_CD
																							 AND A.COL_CD = DD.COL_CD
																							 AND DD.COM_CMP = (SELECT COM_CMP FROM [dbo].[TT_COMCD] WITH (NOLOCK)
																								   							 WHERE CDX_CD = 'C02' AND CCD_CD = 'C02'+CAST( LEFT(A.PLM_NO, 1) AS VARCHAR))		  
						   ),0) END) AS PLD_SUM,
				A.PLM_NO AS PLM_NO									
			  FROM TC_PLANDTL A WITH (NOLOCK)
			 WHERE A.PLM_NO = #{plm_no}
			   AND A.COM_PLDSEC = 'C092'
		  GROUP BY A.ITM_CD, A.COL_CD, A.SET_CD, A.COL_SCD, A.PLD_EQTY, COM_UNDSEC, A.PLD_FQTY, A.PLM_NO ) AA

    UNION ALL
    
	SELECT
		'분해설치' AS 'PLD_SSEC',
		(SELECT TCR.TRI_INM FROM TC_TRINF TCR WITH (NOLOCK) WHERE TCR.TRI_ICD = A.ITM_CD AND TCR.COM_AGSEC = B.COM_AGSEC AND TCR.COM_BRAND = B.COM_BRAND ) AS ITM_NM,
		A.ITM_CD AS 'ITMCD_COL',
		A.ITM_CD AS 'SETCD_COL',
		A.PLD_FQTY AS PLD_FQTY,
		ISNULL(A.PLD_CRAMT , 0) AS PLD_SUM
	  FROM TC_PLANDTL A WITH (NOLOCK), TC_PLANMST B WITH (NOLOCK)
	 WHERE A.PLM_NO = #{plm_no}
	   AND A.COM_PLDSEC = 'C094'
	   AND A.PLM_NO = B.PLM_NO

    UNION ALL

	SELECT
		'폐기장' AS 'PLD_SSEC',
		(SELECT TCR.TRI_INM FROM TC_TRINF TCR WITH (NOLOCK) WHERE TCR.TRI_ICD = A.ITM_CD AND TCR.COM_AGSEC = B.COM_AGSEC AND TCR.COM_BRAND = B.COM_BRAND ) AS ITM_NM,
		A.ITM_CD AS 'ITMCD_COL',
		A.ITM_CD AS 'SETCD_COL',
		A.PLD_FQTY AS PLD_FQTY,
		ISNULL(A.PLD_CRAMT , 0) AS PLD_SUM	  
	  FROM TC_PLANDTL A WITH (NOLOCK), TC_PLANMST B WITH (NOLOCK)
	 WHERE A.PLM_NO = #{plm_no}
	   AND A.COM_PLDSEC = 'C09A'
	   AND A.PLM_NO = B.PLM_NO

    UNION ALL

	SELECT
		AA.PLD_SSEC AS 'PLD_SSEC',
		AA.ITM_NM AS 'ITM_NM',
		AA.ITMCD_COL AS 'ITMCD_COL',
		AA.SETCD_COL AS 'SETCD_COL',
		AA.PLD_FQTY AS 'PLD_FQTY',
		( CASE LEFT(AA.PLM_NO, 1) WHEN 'F' THEN ROUND(AA.PLD_SUM * 1.39, 0) 
								WHEN 'P' THEN ROUND(AA.PLD_SUM * 1.37, 0) 
								ELSE AA.PLD_SUM END  )AS PLD_SUM    
	  FROM ( 
			SELECT
				'반품회수' AS 'PLD_SSEC',
				(SELECT TTI.ITM_NM FROM TT_ITMMST TTI WITH (NOLOCK) WHERE TTI.ITM_CD = A.ITM_CD AND TTI.COL_CD = A.COL_CD ) AS ITM_NM,
				A.ITM_CD + '-' + A.COL_CD AS 'ITMCD_COL',
				ISNULL(A.SET_CD, '') + '-' + ISNULL(A.COL_SCD, '') AS 'SETCD_COL',
				SUM(A.PLD_FQTY) AS PLD_FQTY,
				 (CASE WHEN (A.COM_UNDSEC = 'C52B02' or A.COM_UNDSEC = 'C52C01' or A.COM_UNDSEC = 'C52C02') THEN  ISNULL((SELECT ISNULL(A.PLD_EQTY,0) * ISNULL(DD.ITM_CONSTCST,0) FROM TT_ITMCOP DD WITH (NOLOCK)
																						   WHERE 1=1
																							 AND A.ITM_CD = DD.ITM_CD
																							 AND A.COL_CD = DD.COL_CD
																							 AND DD.COM_CMP = (SELECT COM_CMP FROM [dbo].[TT_COMCD] WITH (NOLOCK)
																								   							 WHERE CDX_CD = 'C02' AND CCD_CD = 'C02'+CAST( LEFT(A.PLM_NO, 1) AS VARCHAR))		  
						   ),0)
																							ELSE  ISNULL((SELECT ISNULL(A.PLD_FQTY,0) * ISNULL(DD.ITM_CONSTCST,0) FROM TT_ITMCOP DD WITH (NOLOCK)
																						   WHERE 1=1
																							 AND A.ITM_CD = DD.ITM_CD
																							 AND A.COL_CD = DD.COL_CD
																							 AND DD.COM_CMP = (SELECT COM_CMP FROM [dbo].[TT_COMCD] WITH (NOLOCK)
																								   							 WHERE CDX_CD = 'C02' AND CCD_CD = 'C02'+CAST( LEFT(A.PLM_NO, 1) AS VARCHAR))		  
						   ),0) END) AS PLD_SUM,
				A.PLM_NO AS PLM_NO	
			  FROM TC_PLANDTL A WITH (NOLOCK)
			 WHERE A.PLM_NO = #{plm_no}
			   AND A.COM_PLDSEC = 'C096'
			 GROUP BY A.ITM_CD, A.COL_CD, A.SET_CD, A.COL_SCD, A.PLD_EQTY, COM_UNDSEC, A.PLD_FQTY, A.PLM_NO ) AA

]]>
</select>


<select id="selectAsMainPage" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPAsMainPage">         
<![CDATA[ 
	SELECT
		'AS'   AS COM_SSEC_NM,
		A.COM_SSEC,
		A.PLM_NO AS PLM_NO,
		SUBSTRING(A.ORM_NO, 1, 13) AS RPT_NO,
		A.ORM_NM AS ORM_NM,
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE CCD_CD = ( SELECT ISNULL(TOO.COM_RPSEC, '' )
																			 FROM TA_RPTREQ TOO WITH (NOLOCK)
																		    WHERE TOO.RPT_NO  = SUBSTRING(A.ORM_NO, 1, 13)
																			  AND TOO.RPT_SEQ = SUBSTRING(A.ORM_NO, 14, 15) ) )  AS COM_RPSEC,		
		( SELECT ISNULL(TOO.CTM_ADDR, '' ) + ' ' + ISNULL(TOO.CTM_ADDR2, '' )
		    FROM TA_RPTREQ TOO WITH (NOLOCK)
		   WHERE TOO.RPT_NO  = SUBSTRING(A.ORM_NO, 1, 13)
		     AND TOO.RPT_SEQ = SUBSTRING(A.ORM_NO, 14, 15) )  AS ORM_GADDR,
		A.AGT_CD AS AGT_CD,
		( SELECT TTV.VND_NM FROM TT_VENDOR TTV WITH (NOLOCK) WHERE TTV.VND_CD = A.AGT_CD) AS AGT_NM,
		( SELECT TTV.VND_TELNO FROM TT_VENDOR TTV WITH (NOLOCK) WHERE TTV.VND_CD = A.AGT_CD) AS ORM_GEMPTEL,
		( SELECT ISNULL(TOO.CTM_HP, '' )
		    FROM TA_RPTREQ TOO WITH (NOLOCK)
		   WHERE TOO.RPT_NO  = SUBSTRING(A.ORM_NO, 1, 13)
		     AND TOO.RPT_SEQ = SUBSTRING(A.ORM_NO, 14, 15) )  AS ORM_HDPHONE,
		( SELECT ISNULL(TOO.CTM_TEL, '' )
		    FROM TA_RPTREQ TOO WITH (NOLOCK)
		   WHERE TOO.RPT_NO  = SUBSTRING(A.ORM_NO, 1, 13)
		     AND TOO.RPT_SEQ = SUBSTRING(A.ORM_NO, 14, 15) )  AS CTM_TEL,		     
		( SELECT ISNULL(TOO.RPT_USRNM, '' )
		    FROM TA_RPTREQ TOO WITH (NOLOCK)
		   WHERE TOO.RPT_NO  = SUBSTRING(A.ORM_NO, 1, 13)
		     AND TOO.RPT_SEQ = SUBSTRING(A.ORM_NO, 14, 15) )  AS CTM_DNM,
		( CASE WHEN ( SELECT COUNT(*)
		                FROM TA_RPTREQ TOO, TA_ASTITEM TAA WITH (NOLOCK)
		               WHERE TOO.RPT_NO  = SUBSTRING(A.ORM_NO, 1, 13)
		                 AND TOO.RPT_SEQ = SUBSTRING(A.ORM_NO, 14, 15)
		                 AND TOO.RPT_NO = TAA.RPT_NO
		                 AND TOO.RPT_SEQ = TAA.RPT_SEQ
		                 AND TAA.COM_SPYCOD = 'A41Y' ) > 0 THEN '유상' ELSE '무상' END )  AS COM_SPYCOD,
		( SELECT ISNULL(TOO.RPT_DESC, '' )
		    FROM TA_RPTREQ TOO WITH (NOLOCK)
		   WHERE TOO.RPT_NO  = SUBSTRING(A.ORM_NO, 1, 13)
		     AND TOO.RPT_SEQ = SUBSTRING(A.ORM_NO, 14, 15) )  AS RPT_DESC,
		( SELECT ISNULL(TOO.RPT_DESCPLUS, '' )
		    FROM TA_RPTREQ TOO WITH (NOLOCK)
		   WHERE TOO.RPT_NO  = SUBSTRING(A.ORM_NO, 1, 13)
		     AND TOO.RPT_SEQ = SUBSTRING(A.ORM_NO, 14, 15) )  AS RPT_DESCPLUS,
		( CASE LEFT(A.ORM_NM, 5) WHEN '(벽고정)' THEN  'Y' ELSE 'N' END ) AS 'WALLFIX_YN',
		'N' AS ORM_GGUBUN,
		'N' AS LDDR_YN,
		'N' AS PLM_ITR,
		'N' AS PLM_EVT,
		'N' AS 'TRASH_YN',
		( CASE WHEN ( SELECT COUNT(*)
		                FROM TC_SCHEDULE TRS WITH (NOLOCK)
		               WHERE TRS.ORM_NO = A.ORM_NO
		                 AND TRS.REM_DT = A.REM_DT )  > 0 THEN 'Y' ELSE 'N' END ) AS 'TRANS_YN',
		'N' AS CANNOT_ONE,
		( SELECT ISNULL(TOO.FILE_ID, '' )
		    FROM TA_RPTREQ TOO WITH (NOLOCK)
		   WHERE TOO.RPT_NO  = SUBSTRING(A.ORM_NO, 1, 13)
		     AND TOO.RPT_SEQ = SUBSTRING(A.ORM_NO, 14, 15) )  AS FILE_ID,
		( SELECT ISNULL(TOO.REFUND_YN, 'N')
		    FROM TA_RPTREQ TOO WITH (NOLOCK)
		   WHERE TOO.RPT_NO  = SUBSTRING(A.ORM_NO, 1, 13)
		     AND TOO.RPT_SEQ = SUBSTRING(A.ORM_NO, 14, 15) )  AS REFUND_YN,
		( SELECT ( CASE WHEN TOO.RPT_RST_ACTTM IS NULL THEN 'N' ELSE 'Y' END )
		    FROM TA_RPTREQ TOO WITH (NOLOCK)
		   WHERE TOO.RPT_NO  = SUBSTRING(A.ORM_NO, 1, 13)
		     AND TOO.RPT_SEQ = SUBSTRING(A.ORM_NO, 14, 15) )  AS SIGONG_YN,
		ISNULL(A.REM_RMK, '')  AS REM_RMK,
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.COM_BRAND ) AS COM_BRAND_NM,
		A.COM_BRAND,
		CASE WHEN ( SELECT ISNULL(TAP.MOB_STARTYN, 'N') FROM TA_PLANMST TAP WITH (NOLOCK) WHERE TAP.PLM_NO = A.PLM_NO AND TAP.PLM_CDT = A.REM_DT ) = 'N' THEN 'N'
			 WHEN ( SELECT ISNULL(TAP.MOB_STARTYN, 'N') FROM TA_PLANMST TAP WITH (NOLOCK) WHERE TAP.PLM_NO = A.PLM_NO AND TAP.PLM_CDT = A.REM_DT ) = 'Y' THEN 'Y' 
			 ELSE 'N' END AS START_YN,
		CASE WHEN ( SELECT ISNULL(TAP.MOB_ENDYN, 'N') FROM TA_PLANMST TAP WITH (NOLOCK) WHERE TAP.PLM_NO = A.PLM_NO AND TAP.PLM_CDT = A.REM_DT ) = 'N' THEN 'N'
			 WHEN ( SELECT ISNULL(TAP.MOB_ENDYN, 'Y') FROM TA_PLANMST TAP WITH (NOLOCK) WHERE TAP.PLM_NO = A.PLM_NO AND TAP.PLM_CDT = A.REM_DT ) = 'Y' THEN 'Y' 
			 ELSE 'N' END AS END_YN,
		A.COM_AGSEC AS COM_AGSEC,
		SUBSTRING(A.ORM_NO, 14, 15) AS RPT_SEQ,
		A.REM_DT AS REM_DT,
		( CASE WHEN (SELECT COUNT(*) 
		   			 FROM TA_PLANMST TCR WITH (NOLOCK)
		  			WHERE TCR.RPT_NO = SUBSTRING(A.ORM_NO, 1, 13)
		  			  AND TCR.RPT_SEQ = SUBSTRING(A.ORM_NO, 14, 15)  ) > 1 THEN 'Y' ELSE 'N' END ) AS REM_CSEC,
		 A.ORM_NO AS ORM_NO,
		 A.REM_SEQ AS REM_SEQ,
		 ( SELECT
		   		CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END
		     FROM TA_PLANDTL TAP WITH (NOLOCK)
		    WHERE TAP.PLM_NO = A.PLM_NO
		      AND TAP.MOB_NFINISHED BETWEEN 'C67006' AND 'C67011' ) AS 'MIGEUL_ADD_YN' ,
		( SELECT ISNULL(TOO.PLM_NO, '' )
		    FROM TA_RPTREQ TOO WITH (NOLOCK)
		   WHERE TOO.RPT_NO  = SUBSTRING(A.ORM_NO, 1, 13)
		     AND TOO.RPT_SEQ = SUBSTRING(A.ORM_NO, 14, 15) )  AS SIGONG_PLM_NO ,
		( SELECT ISNULL(TCS.STI_NM, '') FROM TC_STINF TCS WITH (NOLOCK) WHERE TCS.COM_SCD = A.COM_SCD AND TCS.STI_CD = A.STI_CD ) AS STI_NM,
		A.STI_CD,
		( SELECT TCS.COM_STSEC FROM TC_STINF TCS WITH (NOLOCK) WHERE TCS.STI_CD = A.STI_CD AND TCS.COM_SCD = A.COM_SCD ) AS COM_STSEC,
		A.COM_RFG AS COM_RFG,
		( SELECT ISNULL(TOO.CTM_DNM, '' )
		    FROM TA_RPTREQ TOO WITH (NOLOCK)
		   WHERE TOO.RPT_NO  = SUBSTRING(A.ORM_NO, 1, 13)
		     AND TOO.RPT_SEQ = SUBSTRING(A.ORM_NO, 14, 15) )  AS CTM_DNM2,
		( SELECT TTV.VND_ADDR FROM TT_VENDOR TTV WITH (NOLOCK) WHERE TTV.VND_CD = A.COM_SCD ) AS VND_ADDR,		     
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.REM_PTM ) AS PLM_PTMNM,
		( SELECT TT.CCD_NM FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.REM_FTM ) AS REM_FTMNM,
		( SELECT TT.CCD_NAME FROM TT_COMCD TT WITH (NOLOCK) WHERE TT.CCD_CD = A.REM_FTM ) AS REM_FTMNAME,
		A.REM_FTM AS REM_FTM,
		A.REQ_TIME, A.REQ_LOCATION
	 FROM TC_RESMST A WITH (NOLOCK)
	WHERE A.REM_DT = #{rem_dt}
	  AND A.REM_SEQ = #{rem_seq}
 
]]>
</select>
 
<select id="selectAsItemPage" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPAsItemPage">         
<![CDATA[ 
	SELECT
		(SELECT TTI.BMT_NM
		   FROM TT_BOMMST TTI WITH (NOLOCK)
	     WHERE TTI.BMT_ITEM = A.BMT_ITEM
	       AND TTI.COL_CD = A.COL_CD ) AS BMT_NM,
	A.BMT_ITEM + '-' + A.COL_CD AS 'BMTCD_COL',
	SUM(A.PLD_FQTY) AS PLD_FQTY,
	SUM((B.AST_QQTY * B.BMT_SAMT) * 1.1) AS TOTAL_COST
	FROM TA_PLANDTL A WITH (NOLOCK) LEFT OUTER JOIN 
	(SELECT A.BMT_ITEM, A.COL_CD, A.AST_QQTY, A.BMT_SAMT
	  FROM TA_ASTITEM A WITH(NOLOCK)
	 WHERE A.RPT_NO = SUBSTRING(#{orm_no}, 1, 13)
	AND A.RPT_SEQ = SUBSTRING(#{orm_no}, 14, 15)) B ON A.BMT_ITEM = B.BMT_ITEM AND A.COL_CD = B.COL_CD
	WHERE A.PLM_NO = #{plm_no} /*plm_no*/ 
	GROUP BY A.BMT_ITEM, A.COL_CD
]]>
</select> 

<select id="selectAsItemPage_" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPAsItemPage">         
<![CDATA[ 
	SELECT
		(SELECT TTI.BMT_NM
		   FROM TT_BOMMST TTI WITH (NOLOCK)
	     WHERE TTI.BMT_ITEM = A.BMT_ITEM
	       AND TTI.COL_CD = A.COL_CD ) AS BMT_NM,
	A.BMT_ITEM + '-' + A.COL_CD AS 'BMTCD_COL',
	SUM(A.PLD_FQTY) AS PLD_FQTY 
	FROM TA_PLANDTL A WITH (NOLOCK)
	WHERE A.PLM_NO = #{plm_no}
	GROUP BY A.BMT_ITEM, A.COL_CD
]]>
</select> 

<select id="selectAsFileList" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPAsFileList">         
<![CDATA[ 
   SELECT
   		'첨부파일' AS FILE_TYPE,
		A.ATTCH_FILE_ID AS ATTCH_FILE_ID,
	 	A.REAL_ATTCH_FILE_NAME AS attch_file_NM,
		SUBSTRING(VIRTUAL_ATTCH_FILE_NAME, CHARINDEX('.' ,VIRTUAL_ATTCH_FILE_NAME,  -1)+1, LEN(VIRTUAL_ATTCH_FILE_NAME)) AS FILE_KND,
		A.ATTCH_DIV_CD AS ATTCH_DIV_CD,
		A.ATTCH_FILE_SNUM AS ATTCH_FILE_SNUM
	 FROM TY_ATTCHFILE A
	WHERE ATTCH_FILE_ID = #{file_id}

	UNION ALL
	
   SELECT
   		'첨부파일' AS FILE_TYPE,
		A.ATTCH_FILE_ID AS ATTCH_FILE_ID,
	 	A.REAL_ATTCH_FILE_NAME AS attch_file_NM,
		SUBSTRING(VIRTUAL_ATTCH_FILE_NAME, CHARINDEX('.' ,VIRTUAL_ATTCH_FILE_NAME,  -1)+1, LEN(VIRTUAL_ATTCH_FILE_NAME)) AS FILE_KND,
		A.ATTCH_DIV_CD AS ATTCH_DIV_CD,
		A.ATTCH_FILE_SNUM AS ATTCH_FILE_SNUM
	 FROM TY_ATTCHFILE A
	WHERE ATTCH_FILE_ID = (SELECT 'cresult'+TAR. PLM_NO FROM TA_RPTREQ TAR WITH (NOLOCK) WHERE TAR.RPT_NO + TAR.RPT_SEQ = (SELECT TCR.ORM_NO FROM TC_RESMST TCR WITH (NOLOCK) WHERE TCR.REM_DT = #{rem_dt} AND TCR.REM_SEQ = #{rem_seq}))

]]>
</select>

<select id="selectSigongFileList" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPAsFileList">         
<![CDATA[ 
	SELECT 
		'조립도' AS FILE_TYPE,
		M.ORMNO_CUT AS ATTCH_FILE_ID,
		F.FILE_NAME AS ATTCH_FILE_NM , 
		SUBSTRING(FILE_NAME, CHARINDEX('.' ,FILE_NAME,  -1)+1, LEN(FILE_NAME))AS FILE_KND
	  FROM TO_DEVDET_FILE F WITH (NOLOCK), TO_DEVMAS M WITH (NOLOCK)
	 WHERE M.ORMNO_CUT  = LEFT(#{file_id}, 13)
	   AND M.DEV_STAT IN ('O02069', 'O02070')
	   AND M.DEV_NO = F.DEV_NO
	   AND F.FILE_TYPE = 'O8630'
	
]]>
</select>


<select id="selectSigongFileListCad" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPAsFileList">         
<![CDATA[ 
	
	SELECT
		'시공도면' AS FILE_TYPE,
		CLAIM_NO AS ATTCH_FILE_ID,
		FILE_NAME AS ATTCH_FILE_NM,
		SUBSTRING(FILE_NAME, CHARINDEX('.' ,FILE_NAME,  -1)+1, LEN(FILE_NAME))AS FILE_KND
	  FROM TE_CLAIMFILE WITH (NOLOCK)
	 WHERE CLAIM_NO = ( SELECT TOP 1 PLM_NO FROM TC_PLANMST TCP WITH (NOLOCK) WHERE TCP.ORM_NO = #{file_id} ) 
	   AND FILE_TYPE = 'P'
	

	
]]> 
</select>

<select id="selectSigongFileListCad_new" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPAsFileList">         
<![CDATA[ 
	
	SELECT 
		'시공도면' AS FILE_TYPE,
		A.DATA_KEY AS ATTCH_FILE_ID,
		A.ORGINL_FILE_NM AS ATTCH_FILE_NM,
		SUBSTRING(A.ORGINL_FILE_NM, CHARINDEX('.' ,A.ORGINL_FILE_NM,  -1)+1, LEN(A.ORGINL_FILE_NM))AS FILE_KND,
		A.SEQ AS SEQ,
		A.GRP_ID AS GRP_ID
	FROM TN_COMM_FILE A WITH (NOLOCK)
	WHERE A.DATA_KEY = #{file_id}
	
]]>
</select>



<select id="selectSigongFileListIos" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPAsFileList">         
<![CDATA[ 
	
	SELECT 
		'IOS' AS FILE_TYPE,
		IOS.FRM_NO AS ATTCH_FILE_ID,
		IOS.FRM_NO+'.jpeg' AS ATTCH_FILE_NM,
		'jpeg' AS FILE_KND,
		IOS.IMG_ID AS IMG_ID,
		IOS.IMG_CNT AS IMG_CNT
	FROM TO_FORMMAS_NIOS_IMG IOS WITH (NOLOCK)
	WHERE IOS.FRM_NO = ( SELECT TOO.FRM_NO FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = #{file_id} )
	  AND ( ISNULL(CONVERT(VARCHAR,IMG_CNT),'') = 'IOS' OR ISNULL(CONVERT(VARCHAR,IMG_CNT),'') BETWEEN '1' AND '30' )
	  AND IOS.IMG_CNT <> 0
	
]]>
</select>

<select id="selectScheduleCount" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPScheduleCount">         
<![CDATA[ 
	SELECT
		SUM(BB.TOTAL_CNT) AS TOTAL_CNT,
		SUM(BB.REAL_CNT) AS REAL_CNT
	  FROM (
			SELECT
				ISNULL(COUNT(*), 0) AS TOTAL_CNT,
				( CASE AA.COM_SSEC WHEN 'C18C' THEN ISNULL(COUNT( DISTINCT ISNULL(AA.AGT_CD, '') + ISNULL(AA.ORM_GADDR+ AA.ORM_CDT, '') ), 0) ELSE ISNULL(COUNT(*),  0) END ) AS REAL_CNT
			FROM ( SELECT
						A.ORM_NO AS 'ORM_NO',
						( SELECT TOO.AGT_CD
						   FROM TO_ORDMAS TOO WITH (NOLOCK)
						  WHERE TOO.ORM_NO = A.ORM_NO ) AS 'AGT_CD',
						( SELECT TOO.ORM_GADDR
						   FROM TO_ORDMAS TOO WITH (NOLOCK)
						  WHERE TOO.ORM_NO = A.ORM_NO ) AS 'ORM_GADDR',
						( SELECT TOO.ORM_CDT
						   FROM TO_ORDMAS TOO WITH (NOLOCK)
						  WHERE TOO.ORM_NO = A.ORM_NO ) AS 'ORM_CDT',
						A.COM_SSEC AS COM_SSEC
					FROM TC_RESMST A WITH (NOLOCK)
					WHERE A.STI_CD = #{sti_cd}
					  AND A.COM_SCD = #{com_scd}
					  AND A.REM_DT = #{date}
					  AND A.COM_SSEC = 'C18C'
			
			
					UNION ALL
			
					SELECT
						A.ORM_NO AS 'ORM_NO',
						( SELECT TOO.AGT_CD
						   FROM TO_ORDMAS TOO WITH (NOLOCK)
						  WHERE TOO.ORM_NO = A.ORM_NO ) AS 'AGT_CD',
						( SELECT TOO.ORM_GADDR
						   FROM TO_ORDMAS TOO WITH (NOLOCK)
						  WHERE TOO.ORM_NO = A.ORM_NO ) AS 'ORM_GADDR',
						( SELECT TOO.ORM_CDT
						   FROM TO_ORDMAS TOO WITH (NOLOCK)
						  WHERE TOO.ORM_NO = A.ORM_NO ) AS 'ORM_CDT',
						A.COM_SSEC AS COM_SSEC
					FROM TC_RESMST A WITH (NOLOCK)
					WHERE A.STI_CD = #{sti_cd}
					  AND A.COM_SCD = #{com_scd}
					  AND A.REM_DT = #{date}
					  AND A.COM_SSEC = 'C18A' ) AA
			GROUP BY AA.COM_SSEC ) BB
]]>
</select> 

<select id="selectFinishYnCheckAs" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPResultFinishynCheck">         
<![CDATA[ 
	SELECT
		( CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END ) AS STR_RESULT
 	  FROM TA_PLANMST A WITH (NOLOCK)
	 WHERE A.PLM_NO = #{plm_no}
  	   AND ( A.COM_PLMFG = 'C103' OR A.COM_PLMFG = 'C104' )
]]>
</select> 
<select id="selectFinishYnCheckSigong" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPResultFinishynCheck">         
<![CDATA[ 
	SELECT
		( CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END ) AS STR_RESULT
 	  FROM TC_PLANMST A WITH (NOLOCK)
	 WHERE A.PLM_NO = #{plm_no}
  	   AND ( A.COM_PLMFG = 'C103' OR A.COM_PLMFG = 'C104' )
]]>
</select> 

<update id="updateAddAsStartTime" parameterType="HashMap">
<![CDATA[
	UPDATE TA_PLANMST
	   SET MOB_STARTTM = GETDATE(), MOB_STARTYN = 'Y'
	 WHERE PLM_NO = #{plm_no}
]]>
</update> 

<update id="updateAddSigongStartTime" parameterType="HashMap">
<![CDATA[
	UPDATE TC_PLANMST
	   SET MOB_STARTTM = GETDATE(), MOB_STARTYN = 'Y'
	 WHERE PLM_NO = #{plm_no}
]]>
</update> 

<update id="updateAddAsEndTime" parameterType="HashMap">
<![CDATA[
	UPDATE TA_PLANMST
	   SET MOB_ENDTM = GETDATE(), MOB_ENDYN = 'Y'
	 WHERE PLM_NO = #{plm_no}
]]>
</update> 

<update id="updateAddSigongEndTime" parameterType="HashMap">
<![CDATA[
	UPDATE TC_PLANMST
	   SET MOB_ENDTM = GETDATE(), MOB_ENDYN = 'Y'
	 WHERE PLM_NO = #{plm_no}
]]>
</update> 

 
<select id="selectAsReReserveInfo" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPReReserveInfo">         
<![CDATA[ 

	 SELECT
		DISTINCT TCR.PLM_CDT AS REM_DT, 
		TCS.STI_NM AS STI_NM, 
		(SELECT ISNULL(MAX(TCM.STM_HP), '미등록') FROM TC_STMEMBER TCM WHERE TCM.STI_CD = TCS.STI_CD AND TCM.COM_SCD = TCS.COM_SCD ) AS STM_HP,
		ISNULL((SELECT TTC .CCD_NM 
		   FROM TT_COMCD TTC 
		  WHERE TTC.CCD_CD = (SELECT MAX(TAP.MOB_NFINISHED)
							    FROM TA_PLANDTL TAP WITH (NOLOCK) 
							   WHERE TAP.PLM_NO = TCR.PLM_NO
								 AND TAP.MOB_NFINISHED IN ('C67002', 'C67003', 'C67004', 'C67005' )  ) ), '연기') AS RE_STD
	  FROM TA_PLANMST TCR WITH (NOLOCK), TC_STINF TCS WITH (NOLOCk)
	 WHERE TCR.RPT_NO = SUBSTRING(#{orm_no}, 1, 13)
	   AND TCR.RPT_SEQ = SUBSTRING(#{orm_no}, 14, 15)
	   AND TCS.COM_SCD = TCR.COM_SCD 
	   AND TCR.STI_CD = TCS.STI_CD	   
	   

]]>
</select> 

<select id="selectSigongReReserveInfo" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPReReserveInfo">         
<![CDATA[ 
	 SELECT
		TCR.REM_DT AS REM_DT, 
		TCS.STI_NM AS STI_NM, 
		(SELECT ISNULL(MAX(TCM.STM_HP), '미등록') FROM TC_STMEMBER TCM WHERE TCM.STI_CD = TCS.STI_CD AND TCM.COM_SCD = TCS.COM_SCD ) AS STM_HP,
		ISNULL((SELECT TTC .CCD_NM 
		   FROM TT_COMCD TTC 
		  WHERE TTC.CCD_CD = (SELECT MAX(TAP.MOB_NFINISHED)
							    FROM TC_PLANDTL TAP WITH (NOLOCK) 
							   WHERE TAP.PLM_NO = TCR.PLM_NO
								 AND TAP.MOB_NFINISHED IN ('C687002', 'C68003', 'C68004' )  ) ), '연기') AS RE_STD		
	  FROM TC_RESMST TCR WITH (NOLOCK), TC_STINF TCS WITH (NOLOCk)
	 WHERE TCR.COM_SSEC = 'C18C'
	   AND TCR.ORM_NO = #{orm_no}
	   AND TCS.COM_SCD = TCR.COM_SCD 
	   AND TCR.STI_CD = TCS.STI_CD
	   
	

]]> 
</select> 

<select id="selectGubbunYnInfo" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPGubbunInfo">         
<![CDATA[ 
	SELECT TOP 1
		C.CAR_NO 			AS CAR_NO,
		( SELECT TTC.CCD_NM FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CCD_CD = C.COM_TONSEC ) 		AS COM_TONSEC,
		( SELECT TTC.CCD_NM FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CCD_CD = C.COM_CARLANSEC )	 	AS COM_CARLANSEC,
		C.CAR_DNM 			AS CAR_DNM,
		C.CAR_HPNO 			AS CAR_HPNO
	FROM TR_SCHEDULE A WITH (NOLOCK), TR_PLANDTL B WITH (NOLOCK), TR_PLANMST C WITH (NOLOCK)
	WHERE A.ORM_NO = #{orm_no}
	  AND A.SCH_TRNO = B.SCH_TRNO
	  AND B.PMS_NO = C.PMS_NO
	ORDER BY COM_TONSEC
]]>
</select> 
  
<select id="selectSigongItemNormalResultPage" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPConstructionItemResultPage">         
<![CDATA[ 
    SELECT *
      FROM (
	SELECT 
			'정상시공' AS GUBUN_NM 								
		   ,ISNULL(A.SET_CD, '') AS SET_CD										
		   ,ISNULL(A.COL_SCD, '') AS COL_SCD											
		   ,A.ITM_CD AS ITM_CD										
		   ,(SELECT ISNULL(AA.ITM_NM, '') FROM TT_ITMMST AA WITH (NOLOCK) WHERE 1=1 AND A.ITM_CD = AA.ITM_CD AND A.COL_CD = AA.COL_CD) AS ITM_NM	/* 단품명 */
		   ,A.COL_CD AS COL_CD
		   ,A.PLD_EQTY	AS PLD_EQTY
		   ,ISNULL(A.COM_RDSEC, '')	AS COM_RDSEC
		   ,A.PLM_NO AS PLM_NO		
		   ,ISNULL(A.COM_PLDSEC, '') AS COM_PLDSEC								
		   ,A.ORD_SSEQ AS ORD_SSEQ
		   ,A.ORD_ISEQ	AS ORD_ISEQ								
		   ,ISNULL(C.ORM_GGUBUN, '') AS ORM_GGUBUN		,						
		   '' AS TRS_SEC_2
	  FROM TC_PLANDTL A WITH (NOLOCK)
	  JOIN TC_PLANMST B WITH (NOLOCK) ON 1=1
     				   AND A.PLM_NO = B.PLM_NO
      JOIN TO_ORDMAS C WITH (NOLOCK) ON 1=1
      				  AND B.ORM_NO = C.ORM_NO
	 WHERE 1=1
   	   AND A.PLM_NO = #{plm_no}
   	   AND A.COM_PLDSEC IN ('C090')
   	   AND 'A' = #{gubun}
		
	UNION ALL

	SELECT 
			'매장경유/반품회수' AS GUBUN_NM 					
		   ,ISNULL(A.SET_CD, '') AS SET_CD										
		   ,ISNULL(A.COL_SCD, '') AS COL_SCD											
		   ,A.ITM_CD AS ITM_CD										
		   ,(SELECT ISNULL(AA.ITM_NM, '') FROM TT_ITMMST AA WITH (NOLOCK) WHERE 1=1 AND A.ITM_CD = AA.ITM_CD AND A.COL_CD = AA.COL_CD) AS ITM_NM	/* 단품명 */
		   ,A.COL_CD AS COL_CD
		   ,A.PLD_EQTY	AS PLD_EQTY
		   ,ISNULL(A.COM_RDSEC, '')	AS COM_RDSEC
		   ,A.PLM_NO AS PLM_NO		
		   ,ISNULL(A.COM_PLDSEC, '') AS COM_PLDSEC								
		   ,A.ORD_SSEQ AS ORD_SSEQ
		   ,A.ORD_ISEQ	AS ORD_ISEQ								
		   ,ISNULL(C.ORM_GGUBUN, '') AS ORM_GGUBUN		,						
		   '' AS TRS_SEC_2
	  FROM TC_PLANDTL A WITH (NOLOCK)
	  JOIN TC_PLANMST B WITH (NOLOCK) ON 1=1
     				   AND A.PLM_NO = B.PLM_NO
      JOIN TO_ORDMAS C WITH (NOLOCK) ON 1=1
      				  AND B.ORM_NO = C.ORM_NO
	 WHERE 1=1
 	   AND A.PLM_NO = #{plm_no}
	   AND A.COM_PLDSEC IN ('C092','C096','C095')
	   AND 'B' = #{gubun}
	   
	UNION ALL

	SELECT 
			'분해설치/폐기장' AS GUBUN_NM 					
		   ,ISNULL(A.SET_CD, '') AS SET_CD										
		   ,ISNULL(A.COL_SCD, '') AS COL_SCD											
		   ,A.ITM_CD AS ITM_CD										
		   ,(SELECT CC.TRS_SNM FROM TC_TRSEC CC WITH (NOLOCK) WHERE 1=1 AND A.trs_sec_2 = CC.TRS_SEC) + '/' + (SELECT TRI_INM FROM TC_TRINF AA WITH (NOLOCK) WHERE 1=1 AND AA.TRS_SEC = A.trs_sec_2 AND AA.TRI_ICD = A.ITM_CD) AS ITM_NM	/* 단품명 */
		   ,A.COL_CD AS COL_CD
		   ,A.PLD_EQTY	AS PLD_EQTY
		   ,ISNULL(A.COM_RDSEC, '')	AS COM_RDSEC
		   ,A.PLM_NO AS PLM_NO		
		   ,ISNULL(A.COM_PLDSEC, '') AS COM_PLDSEC								
		   ,A.ORD_SSEQ AS ORD_SSEQ
		   ,A.ORD_ISEQ	AS ORD_ISEQ								
		   ,ISNULL(C.ORM_GGUBUN, '') AS ORM_GGUBUN		,						
		   '' AS TRS_SEC_2
	  FROM TC_PLANDTL A WITH (NOLOCK)
	  JOIN TC_PLANMST B WITH (NOLOCK) ON 1=1
     				   AND A.PLM_NO = B.PLM_NO
      JOIN TO_ORDMAS C WITH (NOLOCK) ON 1=1
      				  AND B.ORM_NO = C.ORM_NO
	 WHERE 1=1
	   AND A.PLM_NO = #{plm_no}
       AND A.COM_PLDSEC IN ('C094','C09A')
	   AND 'C' = #{gubun}
	   ) A
	 ORDER BY A.SET_CD, A.COL_SCD, A.ITM_CD
]]>
</select>

<select id="selectSigongItemResultPage" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPConstructionItemResultPage">         
<![CDATA[ 
    SELECT *
      FROM (
	SELECT 
			'정상시공' AS GUBUN_NM 								
		   ,ISNULL(A.SET_CD, '') AS SET_CD										
		   ,ISNULL(A.COL_SCD, '') AS COL_SCD											
		   ,A.ITM_CD AS ITM_CD										
		   ,(SELECT ISNULL(AA.ITM_NM, '') FROM TT_ITMMST AA WITH (NOLOCK) WHERE 1=1 AND A.ITM_CD = AA.ITM_CD AND A.COL_CD = AA.COL_CD) AS ITM_NM	/* 단품명 */
		   ,A.COL_CD AS COL_CD
		   ,A.PLD_EQTY	AS PLD_EQTY
		   ,ISNULL(A.COM_RDSEC, '')	AS COM_RDSEC
		   ,A.PLM_NO AS PLM_NO		
		   ,ISNULL(A.COM_PLDSEC, '') AS COM_PLDSEC								
		   ,A.ORD_SSEQ AS ORD_SSEQ
		   ,A.ORD_ISEQ	AS ORD_ISEQ								
		   ,ISNULL(C.ORM_GGUBUN, '') AS ORM_GGUBUN		,						
		   '' AS TRS_SEC_2
	  FROM TC_PLANDTL A WITH (NOLOCK)
	  JOIN TC_PLANMST B WITH (NOLOCK) ON 1=1
     				   AND A.PLM_NO = B.PLM_NO
      JOIN TO_ORDMAS C WITH (NOLOCK) ON 1=1
      				  AND B.ORM_NO = C.ORM_NO
	 WHERE 1=1
   	   AND A.PLM_NO = #{plm_no}
   	   AND A.COM_PLDSEC IN ('C090')
   	   AND 'A' = #{gubun}
		
	UNION ALL

	SELECT 
			'매장경유/반품회수' AS GUBUN_NM 					
		   ,ISNULL(A.SET_CD, '') AS SET_CD										
		   ,ISNULL(A.COL_SCD, '') AS COL_SCD											
		   ,A.ITM_CD AS ITM_CD										
		   ,(SELECT ISNULL(AA.ITM_NM, '') FROM TT_ITMMST AA WITH (NOLOCK) WHERE 1=1 AND A.ITM_CD = AA.ITM_CD AND A.COL_CD = AA.COL_CD) AS ITM_NM	/* 단품명 */
		   ,A.COL_CD AS COL_CD
		   ,A.PLD_EQTY	AS PLD_EQTY
		   ,ISNULL(A.COM_RDSEC, '')	AS COM_RDSEC
		   ,A.PLM_NO AS PLM_NO		
		   ,ISNULL(A.COM_PLDSEC, '') AS COM_PLDSEC								
		   ,A.ORD_SSEQ AS ORD_SSEQ
		   ,A.ORD_ISEQ	AS ORD_ISEQ								
		   ,ISNULL(C.ORM_GGUBUN, '') AS ORM_GGUBUN		,						
		   '' AS TRS_SEC_2
	  FROM TC_PLANDTL A WITH (NOLOCK)
	  JOIN TC_PLANMST B WITH (NOLOCK) ON 1=1
     				   AND A.PLM_NO = B.PLM_NO
      JOIN TO_ORDMAS C WITH (NOLOCK) ON 1=1
      				  AND B.ORM_NO = C.ORM_NO
	 WHERE 1=1
 	   AND A.PLM_NO = #{plm_no}
	   AND A.COM_PLDSEC IN ('C092','C096','C095')
	   AND 'B' = #{gubun}
	   
	UNION ALL

	SELECT 
			'분해설치/폐기장' AS GUBUN_NM 					
		   ,ISNULL(A.SET_CD, '') AS SET_CD										
		   ,ISNULL(A.COL_SCD, '') AS COL_SCD											
		   ,A.ITM_CD AS ITM_CD										
		   ,(SELECT CC.TRS_SNM FROM TC_TRSEC CC WITH (NOLOCK) WHERE 1=1 AND A.trs_sec_2 = CC.TRS_SEC) + '/' + (SELECT TRI_INM FROM TC_TRINF AA WITH (NOLOCK) WHERE 1=1 AND AA.TRS_SEC = A.trs_sec_2 AND AA.TRI_ICD = A.ITM_CD) AS ITM_NM	/* 단품명 */
		   ,A.COL_CD AS COL_CD
		   ,A.PLD_EQTY	AS PLD_EQTY
		   ,ISNULL(A.COM_RDSEC, '')	AS COM_RDSEC
		   ,A.PLM_NO AS PLM_NO		
		   ,ISNULL(A.COM_PLDSEC, '') AS COM_PLDSEC								
		   ,A.ORD_SSEQ AS ORD_SSEQ
		   ,A.ORD_ISEQ	AS ORD_ISEQ								
		   ,ISNULL(C.ORM_GGUBUN, '') AS ORM_GGUBUN		,						
		   '' AS TRS_SEC_2
	  FROM TC_PLANDTL A WITH (NOLOCK)
	  JOIN TC_PLANMST B WITH (NOLOCK) ON 1=1
     				   AND A.PLM_NO = B.PLM_NO
      JOIN TO_ORDMAS C WITH (NOLOCK) ON 1=1
      				  AND B.ORM_NO = C.ORM_NO
	 WHERE 1=1
	   AND A.PLM_NO = #{plm_no}
       AND A.COM_PLDSEC IN ('C094','C09A')
	   AND 'C' = #{gubun}
	   ) A
	 ORDER BY A.ITM_CD
]]>
</select>
    
<insert id="sigongBanpumAgtRequestInsert" parameterType="HashMap">
<![CDATA[ 
    INSERT INTO TC_STIREQ
	           (PLM_NO,
	            SET_CD,
	            COL_SCD,
	            ITM_CD,
	            COL_CD,
	            REQ_QTY,
	            STI_CD,
	            REQ_RMK,
	            END_YN,
	            USR_CD,
	            SYS_DT)
	SELECT
		AAA.PLM_NO, AAA.SET_CD, AAA.COL_SCD, AAA.ITM_CD, AAA.COL_CD, SUM(AAA.REQ_QTY), AAA.STI_CD, AAA.REQ_RMK,  AAA.END_YN, AAA.USR_CD, GETDATE() 
	  FROM ( SELECT #{plm_no} AS PLM_NO, AA.DATA AS SET_CD, BB.DATA AS COL_SCD, CC.DATA AS ITM_CD, DD.DATA AS COL_CD, CONVERT(INT, EE.DATA) AS REQ_QTY, #{sti_cd} AS STI_CD, '.' AS REQ_RMK, 'N' AS END_YN, #{user_id} AS USR_CD
	  FROM dbo.fnSplit(#{set_cd_arr}) AA, dbo.fnSplit(#{col_scd_arr}) BB, dbo.fnSplit(#{itm_cd_arr}) CC, dbo.fnSplit(#{col_cd_arr}) DD, dbo.fnSplit(#{req_qty_arr}) EE
	 WHERE  AA.SEQNO = BB.SEQNO
	   AND BB.SEQNO = CC.SEQNO
	   AND CC.SEQNO = DD.SEQNO
	   AND DD.SEQNO = EE.SEQNO ) AAA
	GROUP BY AAA.PLM_NO, AAA.SET_CD, AAA.COL_SCD, AAA.ITM_CD, AAA.COL_CD, AAA.STI_CD,  AAA.REQ_RMK, AAA.END_YN, AAA.USR_CD		
]]>
</insert>

<select id="getNowTime" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.DataResult">
<![CDATA[
	SELECT CONVERT(INT,CONVERT(CHAR(8), DATEPART(HH,GETDATE()), 112)) AS DATA1
]]>
</select>

<insert id="insertNightTimeJungsan" parameterType="HashMap">
<![CDATA[ 
	INSERT INTO TC_PLANDTL
	(
	  PLM_NO
	  , COM_PLDSEC
	  , ORD_SSEQ
	  , ORD_ISEQ
	  , ITM_CD
	  , COL_CD
	  , SET_CD
	  , COL_SCD
	  , PLD_EQTY
	  , PLD_FQTY
	  , ITM_CBM
	  , ITM_TOTWGT
	  , PLD_FAMT
	  , PLD_CRAMT
	  , PLD_CFAMT
	  , PLD_CUSAMT
	  , BMT_SGRADE
	  , COM_TRSEC
	  , ITM_STCCD
	  , PLD_ASSMYN
	  , ITM_OVERCMP
	  , TRS_SEC
	  , COM_STKSEC
	  , COM_RDSEC
	  , COM_UNDSEC
	  , COM_UNPSEC
	  , PLD_RCDT
	  , PLD_RASDT
	  , PLD_RMK
	  , USR_CD
	  , SYS_DT
	  , WTR_NO
	  , WTR_SEQNO
	  , WTI_NO
	  , WTP_NO
	  , COM_ACD
	  , COM_SVND
	  , COM_VFSEC
	  , COM_VTSEC
	  , COM_RASEC
	  , PLD_CSEC
	  , COM_UNDSEC1
	  , COM_UNDSEC2
	)
	VALUES
	(
		#{plm_no} 
	   ,'C0929'
	   , '07P'
	   , '001'
	   , ''
	   , ''
	   , ''
	   , ''
	   , NULL
	   , 1
	   , NULL
	   , NULL
	   , 5000
	   , 0
	   , 5000
	   , 0
	   , ''
	   , ''
	   , ''
	   , ''
	   , ''
	   , ''
	   , ''
	   , 'C13W'
	   , ''
	   , ''
	   , ''
	   , ''
	   , '저녁시공건(AUTO)'
	   , #{user_id}
	   , GETDATE()
	   , ''
	   , NULL
	   , ''
	   , ''
	   , 'C01090'
	   , 'C21I'
	   , 'C2404'
	   , 'C2501'
	   , 'C12C'
	   , 'Y'
	   , ''
	   , ''
	)
]]>
</insert>
 
<update id="updateStiReqTime" parameterType="HashMap">
<selectKey keyProperty="ccd_nm" resultType="String" order="AFTER"> 
	SELECT TOP 1 CCD_NM FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CDX_CD = 'C70' AND CCD_NAME = #{req_time}
</selectKey>
<![CDATA[
	UPDATE TC_RESMST
	   SET REM_FTM = ( SELECT TTC.CCD_CD FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CDX_CD = 'C70' AND CCD_NAME = #{req_time} ),
	       ARRIVALTM_SENDYN = 'N'
	 WHERE rem_dt = #{rem_dt}
	   and rem_seq = #{rem_seq}
]]>
</update> 

<update id="updateStiReqTimeSort" parameterType="HashMap">
<![CDATA[
	UPDATE TC_RESMST
	SET ARRIVAL_SEQ = B.ARRIVAL_SEQ
		FROM TC_RESMST A, (
							SELECT ROW_NUMBER() OVER(ORDER BY ISNULL(A.REM_FTM, 'XXXXXX'), A.REM_SEQ) ARRIVAL_SEQ,
							       A.REM_DT, A.REM_SEQ 
							FROM TC_RESMST A
							WHERE A.REM_DT  = #{rem_dt}
							AND A.STI_CD = #{sti_cd}
							) B
		WHERE A.REM_DT = B.REM_DT
	    AND A.REM_SEQ = B.REM_SEQ
]]>
</update> 
 
<update id="updateStiReqTimeSend" parameterType="HashMap">
<![CDATA[
	UPDATE TC_RESMST
	SET ARRIVALTM_SENDYN = 'Y', ARRIVALTM_SEND_DATE = GETDATE()
		FROM TC_RESMST A, (
							SELECT a.data REM_DT,
								   b.data REM_SEQ 
							FROM dbo.fnSplit(#{rem_dt_arr}) a, dbo.fnSplit(#{rem_seq_arr}) b
							WHERE a.seqno = b.seqno
							) B
		WHERE A.REM_DT = B.REM_DT
	    AND A.REM_SEQ = B.REM_SEQ
]]>
</update> 

<select id="selectStiReqTimeSendList" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPStiReqTimeSendList">         
<![CDATA[ 
	SELECT
		A.REM_DT AS REM_DT,
		A.REM_SEQ AS REM_SEQ, 
		A.ORM_NO AS ORM_NO,
		( CASE A.COM_SCD WHEN 'C16YA' THEN ( SELECT ISNULL(TTC.REF_1, '') FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CCD_CD = A.REM_FTM )
					     WHEN 'C16JJ' THEN ( SELECT ISNULL(TTC.REF_3, '') FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CCD_CD = A.REM_FTM )
						 WHEN 'C16KW' THEN ( SELECT ISNULL(TTC.REF_3, '') FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CCD_CD = A.REM_FTM )
						 WHEN 'C16JB' THEN ( SELECT ISNULL(TTC.REF_3, '') FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CCD_CD = A.REM_FTM )
						 WHEN 'C16GJ' THEN ( SELECT ISNULL(TTC.REF_3, '') FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CCD_CD = A.REM_FTM )
						 WHEN 'C16GN' THEN ( SELECT ISNULL(TTC.REF_3, '') FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CCD_CD = A.REM_FTM )						
					     WHEN 'C16DG' THEN ( SELECT ISNULL(TTC.REF_3, '') FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CCD_CD = A.REM_FTM )
						 ELSE ( SELECT ISNULL(TTC.REF_4, '') FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CCD_CD = A.REM_FTM )
						 END ) AS REM_FTM,
		A.ORM_NM AS ORM_NM,
		( SELECT ISNULL(TOO.ORM_HDPHONE, '' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) AS ORM_HDPHONE,
		( SELECT TCS.STI_NM FROM TC_STINF TCS WITH (NOLOCK) WHERE TCS.COM_SCD = A.COM_SCD AND TCS.STI_CD = A.STI_CD ) AS STI_NM,
		A.STI_CD AS STI_CD,
		A.COM_SSEC AS COM_SSEC,
		A.COM_AGSEC AS COM_AGSEC,
		A.COM_BRAND AS COM_BRAND_CD,
		ISNULL((  SELECT ISNULL(TCP.COM_RMFG,'C13W') FROM TC_PLANMST TCP WHERE TCP.PLM_NO = A.PLM_NO ), 'C13W') AS COM_RMFG
	FROM TC_RESMST A WITH (NOLOCK)
	WHERE A.COM_SCD = #{com_scd}	
	  AND A.STI_CD = #{sti_cd}	
	  AND A.REM_DT = #{rem_dt}
	  AND A.COM_SSEC = 'C18C'
	  AND ( A.REM_FTM LIKE 'C70%'  AND A.REM_FTM <> 'C70048' )
	UNION ALL
	SELECT 
		A.REM_DT AS REM_DT,
		A.REM_SEQ AS REM_SEQ,
		A.ORM_NO AS ORM_NO,
		( CASE A.COM_SCD WHEN 'C16DJ' THEN ( SELECT ISNULL(TTC.REF_4, '') FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CCD_CD = A.REM_FTM )
						 ELSE ( SELECT ISNULL(TTC.REF_2, '') FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CCD_CD = A.REM_FTM )
						 END ) AS REM_FTM,
		A.ORM_NM AS ORM_NM,
		( SELECT ISNULL(B.CTM_HP, '') 
			 FROM TA_RPTREQ B WITH (NOLOCK)
         WHERE SUBSTRING(A.ORM_NO, 1, 13) = B.RPT_NO 
			  AND SUBSTRING(A.ORM_NO, 14, 15) = B.RPT_SEQ ) AS ORM_HDPHONE,
		( SELECT TCS.STI_NM FROM TC_STINF TCS WITH (NOLOCK) WHERE TCS.COM_SCD = A.COM_SCD AND TCS.STI_CD = A.STI_CD ) AS STI_NM,
		A.STI_CD AS STI_CD,
		A.COM_SSEC AS COM_SSEC,
		A.COM_AGSEC AS COM_AGSEC,
		A.COM_BRAND AS COM_BRAND_CD	,
		ISNULL((  SELECT ( CASE TCP.COM_RMFG WHEN NULL THEN 'C13W' WHEN '' THEN 'C13W' ELSE TCP.COM_RMFG END )  FROM TA_PLANMST TCP WHERE TCP.PLM_NO = A.PLM_NO ), 'C13W') AS COM_RMFG		  		
	FROM TC_RESMST A WITH (NOLOCK)
	WHERE A.COM_SCD = #{com_scd}
	  AND A.STI_CD = #{sti_cd}	
	  AND A.REM_DT = #{rem_dt}
	  AND A.COM_SSEC = 'C18A'
	  AND (SELECT COUNT(1) FROM TA_PLANDTL TP WHERE TP.PLM_NO = A.PLM_NO ) > 0
	  AND ( A.REM_FTM LIKE 'C70%' AND A.REM_FTM <> 'C70048' )
]]>
</select> 

<select id="selectStiReqTimeSendListCheck" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPStiReqTimeSendList">         
<![CDATA[ 
	SELECT
		A.REM_DT AS REM_DT,
		A.REM_SEQ AS REM_SEQ, 
		A.ORM_NO AS ORM_NO,
		( SELECT ISNULL(TTC.CCD_NM, '') FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CCD_CD = A.REM_FTM ) AS REM_FTM,
		A.ORM_NM AS ORM_NM,
		( SELECT ISNULL(TOO.ORM_HDPHONE, '' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = A.ORM_NO ) AS ORM_HDPHONE,
		( SELECT TCS.STI_NM FROM TC_STINF TCS WITH (NOLOCK) WHERE TCS.COM_SCD = A.COM_SCD AND TCS.STI_CD = A.STI_CD ) AS STI_NM,
		A.STI_CD AS STI_CD,
		A.COM_SSEC AS COM_SSEC,
		A.COM_AGSEC AS COM_AGSEC,
		A.COM_BRAND AS COM_BRAND_CD
	FROM TC_RESMST A WITH (NOLOCK)
	WHERE A.COM_SCD = #{com_scd}	
	  AND A.STI_CD = #{sti_cd}	
	  AND A.REM_DT = #{rem_dt}
	  AND A.COM_SSEC = 'C18C'
	  AND (ISNULL(A.ARRIVALTM_SENDYN, 'N') = 'N' OR LEN(ISNULL(A.ARRIVALTM_SENDYN, '')) = 0)
	  AND A.REM_FTM NOT LIKE 'C70%' 
	UNION ALL
	SELECT
		A.REM_DT AS REM_DT,
		A.REM_SEQ AS REM_SEQ,
		A.ORM_NO AS ORM_NO,
		( SELECT ISNULL(TTC.CCD_NM, '') FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CCD_CD = A.REM_FTM ) AS REM_FTM,
		A.ORM_NM AS ORM_NM,
		( SELECT ISNULL(B.CTM_HP, '') 
			 FROM TA_RPTREQ B WITH (NOLOCK)
         WHERE SUBSTRING(A.ORM_NO, 1, 13) = B.RPT_NO 
			  AND SUBSTRING(A.ORM_NO, 14, 15) = B.RPT_SEQ ) AS ORM_HDPHONE,
		( SELECT TCS.STI_NM FROM TC_STINF TCS WITH (NOLOCK) WHERE TCS.COM_SCD = A.COM_SCD AND TCS.STI_CD = A.STI_CD ) AS STI_NM,
		A.STI_CD AS STI_CD,
		A.COM_SSEC AS COM_SSEC,
		A.COM_AGSEC AS COM_AGSEC,
		A.COM_BRAND AS COM_BRAND_CD		  		
	FROM TC_RESMST A WITH (NOLOCK)
	WHERE A.COM_SCD = #{com_scd}
	  AND A.STI_CD = #{sti_cd}	
	  AND A.REM_DT = #{rem_dt}
	  AND A.COM_SSEC = 'C18A'
	  AND (SELECT COUNT(1) FROM TA_PLANDTL TP WHERE TP.PLM_NO = A.PLM_NO ) > 0
	  AND (ISNULL(A.ARRIVALTM_SENDYN, 'N') = 'N' OR LEN(ISNULL(A.ARRIVALTM_SENDYN, '')) = 0)
	  AND A.REM_FTM NOT LIKE 'C70%'

]]>
</select> 

<select id="selectKakaotalkMessage" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.DataResult">        
<![CDATA[

	SELECT
		A.RMK1 AS DATA1
	  FROM TC_SMSM A WITH (NOLOCK)
	 WHERE A.COM_AGSEC = #{com_agsec}
	   AND A.COM_BRAND = #{com_brand_cd}
	   AND A.SOT_CD = ( CASE WHEN #{com_ssec} = 'C18C' THEN 'C65001' ELSE 'C65002' END )
	   AND A.B_CH_CD = 'C63002'
	   AND A.B_GUBUN_CD = 'C62020'
	   AND A.B_TAR_CD = 'C64003'
	   AND A.USE_YN = 'Y'
]]>
</select>

<select id="selectStmInfoList" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPStmInfo">        
<![CDATA[ 
	SELECT
		(SELECT TTC.CCD_NM FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CCD_CD = A.COM_SCD ) AS COM_SCD
	  , A.STI_CD AS STI_CD
	  , B.STM_NM AS STM_NM
	  , B.STM_HP AS STM_HP
	FROM TC_STINF A WITH (NOLOCK), TC_STMEMBER B WITH (NOLOCK)
	WHERE A.STI_CD = B.STI_CD
	  AND A.COM_SCD = B.COM_SCD
	  AND A.STI_RANK = 'Y'
	  AND B.STM_NM LIKE '%'+#{stm_nm}+'%'
]]>
</select>

<select id="selectAgtInfoList" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPAgtInfo">        
<![CDATA[ 
	SELECT 
		(SELECT TTC.CCD_NM FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CCD_CD = ( SELECT TOP 1 B.COM_CMP FROM TT_VNDCOP B WITH (NOLOCK) WHERE B.VND_CD = A.VND_CD AND B.VOP_STU = 'T4201' AND B.COM_CMP <> 'T01B' AND B.COM_CMP <> 'T01T') ) AS COM_CMP             
		,ISNULL(A.VND_NM, '')+'('+ISNULL(A.VND_NAME, '')+')' AS VND_NM                
		,ISNULL(A.VND_PRSDNT, '') AS VND_PRSDNT           
		,ISNULL(A.VND_ADDR, '') + ' ' + ISNULL(A.VND_ADDRDTL, '') AS VND_ADDR                
		,ISNULL(A.VND_TELNO, '') AS VND_TELNO            
	FROM TT_VENDOR A WITH (NOLOCK)
 WHERE  EXISTS ( SELECT 'X' FROM TT_VNDCOP B WITH (NOLOCK) WHERE B.VND_CD = A.VND_CD AND B.VOP_STU = 'T4201' AND B.COM_CMP <> 'T01B' AND B.COM_CMP <> 'T01T'  )   	
   AND A.VND_NM LIKE '%'+#{vnd_nm}+'%'
   AND A.VND_DLVCD = 'T4101'
   AND NOT EXISTS ( SELECT 'X' FROM TT_VNDCOP B WITH (NOLOCK) WHERE B.VND_CD = A.VND_CD AND B.VOP_STU = 'T4201' AND B.COM_CMP = 'T01B' )      
   
]]> 
</select> 

<select id="selectSigongSearchInfoByItem" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPSigongSearchInfo">         
<![CDATA[
	SELECT
		TCR.REM_DT AS REM_DT,
		TCR.REM_SEQ AS REM_SEQ,
		TCR.ORM_NM AS ORM_NM,
		( SELECT CCD_NM FROM TT_COMCD WHERE CCD_CD = TCR.COM_SSEC ) AS COM_SSEC,
		(SELECT CCD_NM FROM TT_COMCD WHERE CCD_CD = TCR.COM_SCD ) AS COM_SCD_NM,
		(SELECT TCS.STI_NM 
		   FROM TC_STINF TCS WITH (NOLOCK) 
		  WHERE TCS.COM_SCD = TCR.COM_SCD 
		    AND TCS.STI_CD = TCR.STI_CD ) AS STI_NM,
		TCR.ORM_AMT AS ORM_AMT,
		(SELECT CCD_NM FROM TT_COMCD WHERE CCD_CD = TCR.REM_FTM ) AS REM_FTM,
		(SELECT CCD_NM FROM TT_COMCD WHERE CCD_CD = TCR.COM_BRAND ) AS COM_BRAND,
	    (CASE TCR.COM_SSEC WHEN 'C18C' THEN ( SELECT ISNULL(TOO.ORM_GADDR, '' ) + ISNULL(TOO.ADDR_DTL , '' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = TCR.ORM_NO ) 
		                   ELSE  ( SELECT ISNULL(B.CTM_ADDR, '') + ISNULL(B.CTM_ADDR2, '')
									 FROM TA_RPTREQ B WITH (NOLOCK)
									WHERE SUBSTRING(TCR.ORM_NO, 1, 13) = B.RPT_NO 
									  AND SUBSTRING(TCR.ORM_NO, 14, 15) = B.RPT_SEQ ) END ) AS ORM_GADDR,
	    (CASE TCR.COM_SSEC WHEN 'C18C' THEN ( SELECT ISNULL(TOO.ORM_HDPHONE, '' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = TCR.ORM_NO ) 
		                   ELSE  ( SELECT ISNULL(B.CTM_TEL, '') + ' / ' + ISNULL(B.CTM_HP, '')
									 FROM TA_RPTREQ B WITH (NOLOCK)
									WHERE SUBSTRING(TCR.ORM_NO, 1, 13) = B.RPT_NO 
									  AND SUBSTRING(TCR.ORM_NO, 14, 15) = B.RPT_SEQ ) END ) AS ORM_HDPHONE,
		TCR.ORM_NO AS ORM_NO		
	  FROM (
			SELECT DISTINCT A.*
			  FROM TC_RESMST A WITH (NOLOCK), TC_PLANDTL B WITH (NOLOCK)
			 WHERE A.PLM_NO = B.PLM_NO
			   AND A.COM_SSEC = 'C18C'
			   AND A.COM_SCD = #{com_scd}
			   AND A.REM_DT BETWEEN #{from_dt} AND #{to_dt} 
			   AND B.ITM_CD LIKE #{itm_cd}+'%'
			UNION ALL
			SELECT DISTINCT A.*
			  FROM TC_RESMST A WITH (NOLOCK), TC_PLANDTL B WITH (NOLOCK)
			 WHERE A.PLM_NO = B.PLM_NO
			   AND A.COM_SSEC = 'C18A'
			   AND A.COM_SCD = #{com_scd}
			   AND A.REM_DT BETWEEN #{from_dt} AND #{to_dt} 
			   AND B.ITM_CD LIKE #{itm_cd}+'%' 
			) TCR 
]]>
</select>

<select id="selectSigongSearchInfo" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPSigongSearchInfo">         
<![CDATA[ 
	SELECT
		TCR.REM_DT AS REM_DT,
		TCR.REM_SEQ AS REM_SEQ,
		TCR.ORM_NM AS ORM_NM,
		( SELECT CCD_NM FROM TT_COMCD WHERE CCD_CD = TCR.COM_SSEC ) AS COM_SSEC,
		(SELECT CCD_NM FROM TT_COMCD WHERE CCD_CD = TCR.COM_SCD ) AS COM_SCD_NM,
		(SELECT TCS.STI_NM 
		   FROM TC_STINF TCS WITH (NOLOCK) 
		  WHERE TCS.COM_SCD = TCR.COM_SCD 
		    AND TCS.STI_CD = TCR.STI_CD ) AS STI_NM,
		TCR.ORM_AMT AS ORM_AMT,
		(SELECT CCD_NM FROM TT_COMCD WHERE CCD_CD = TCR.REM_FTM ) AS REM_FTM,
		(SELECT CCD_NM FROM TT_COMCD WHERE CCD_CD = TCR.COM_BRAND ) AS COM_BRAND,
	    (CASE TCR.COM_SSEC WHEN 'C18C' THEN ( SELECT ISNULL(TOO.ORM_GADDR, '' ) + ISNULL(TOO.ADDR_DTL , '' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = TCR.ORM_NO ) 
		                   ELSE  ( SELECT ISNULL(B.CTM_ADDR, '') + ISNULL(B.CTM_ADDR2, '')
									 FROM TA_RPTREQ B WITH (NOLOCK)
									WHERE SUBSTRING(TCR.ORM_NO, 1, 13) = B.RPT_NO 
									  AND SUBSTRING(TCR.ORM_NO, 14, 15) = B.RPT_SEQ ) END ) AS ORM_GADDR,
	    (CASE TCR.COM_SSEC WHEN 'C18C' THEN ( SELECT ISNULL(TOO.ORM_HDPHONE, '' ) FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = TCR.ORM_NO ) 
		                   ELSE  ( SELECT ISNULL(B.CTM_TEL, '') + ' / ' + ISNULL(B.CTM_HP, '')
									 FROM TA_RPTREQ B WITH (NOLOCK)
									WHERE SUBSTRING(TCR.ORM_NO, 1, 13) = B.RPT_NO 
									  AND SUBSTRING(TCR.ORM_NO, 14, 15) = B.RPT_SEQ ) END ) AS ORM_HDPHONE,
		TCR.ORM_NO AS ORM_NO		
	  FROM TC_RESMST TCR WITH (NOLOCK)
	 WHERE TCR.REM_DT BETWEEN #{from_dt} AND #{to_dt}
	   AND TCR.ORM_NM LIKE '%' +#{orm_nm}+'%'
	   AND TCR.COM_SCD = #{com_scd}
]]>
</select>

<select id="selectSigongSearchDetailInfo" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPSigongSearchDetailInfo">         
<![CDATA[ 
	  SELECT A.ITM_CD + '-' + A.COL_CD			AS ITMCD_COL
		   , B.ITM_NM							AS ITM_NM
	       , '정상시공'							AS COM_PLDSEC
	       , SUM(A.ORD_QTY)						AS QTY
	       , SUM(A.ORD_CST * A.ORD_QTY)			AS AMT
	   FROM  TO_ORDDET A WITH (NOLOCK)
		   , TT_ITMMST B WITH (NOLOCK)
	       , TT_ITMCOP C WITH (NOLOCK)
	  WHERE  B.ITM_CD = A.ITM_CD 
	    AND  B.COL_CD = A.COL_CD 
	    AND  C.ITM_CD = A.ITM_CD
	    AND  C.COL_CD = A.COL_CD	
		AND  ISNULL(A.ORD_PURCD,'') <> '110452'
		AND  ISNULL(A.ORD_PURCD,'') <> '110284'
		AND  ISNULL(A.ORD_PURCD,'') <> '120995'
		AND  ISNULL(A.ORD_PURCD,'') <> '110815'
		AND  ISNULL(A.ORD_PURCD,'') <> '131297'		
		AND  C.COM_CMP = 'T01'+SUBSTRING(A.ORM_NO,1,1)			
		AND  A.ORM_NO = CAST( #{orm_no} AS VARCHAR)
   GROUP BY  A.ORM_NO   
	       , A.ITM_CD		
	       , A.COL_CD		
	       , A.ORD_TWHSCD	
	       , A.STK_CD		
	       , A.SET_CD		
	       , A.COL_SCD		
		   , B.ITM_NM		
		   , B.ITM_WIDTH	
		   , B.ITM_DEPTH	
		   , B.ITM_HEIGHT	
		   , B.ITM_DESC		
	       , C.IOP_FINEST	
	
  UNION ALL
	
	 SELECT  ISNULL(D.ITM_CD, '') + '-' + ISNULL(D.COL_CD, '')			AS ITMCD_COL
	       , ISNULL(D.TRS_SEC, '') + ISNULL(D.ITM_CD, '')				AS ITM_NM	
	       ,(CASE WHEN D.COM_PLDSEC = 'C090'  THEN '일반'
			   	   WHEN D.COM_PLDSEC = 'C096' THEN '반품회수'
			       WHEN D.COM_PLDSEC = 'C092' THEN '매장경유'
			   	   WHEN D.COM_PLDSEC = 'C094' THEN '분해설치'
			   	   WHEN D.COM_PLDSEC = 'C09A' THEN '폐기장' 
			   	   WHEN D.COM_PLDSEC = 'C095' THEN '샘플회수'
			   	   							  ELSE '기타'
	    	END)														AS COM_PLDSEC
		   , SUM(D.PLD_EQTY)											AS QTY
	       , SUM(D.PLD_FAMT * D.PLD_EQTY)								AS AMT
	   FROM  TC_PLANMST C WITH (NOLOCK)
	   	     LEFT OUTER JOIN TC_PLANDTL D WITH (NOLOCK) ON C.PLM_NO = D.PLM_NO 
	         LEFT OUTER JOIN TC_PLANSPC E WITH (NOLOCK) ON C.PLM_NO = E.PLM_NO   
	  WHERE  
			 D.COM_PLDSEC <> 'C090'		 
	    AND  C.PLM_CDT = CAST( #{rem_dt} AS VARCHAR)
	    AND  C.ORM_NO = CAST( #{orm_no} AS VARCHAR)
    GROUP BY  C.ORM_NO
	        , D.ITM_CD
	        , D.COL_CD
	        , D.COM_STKSEC
	        , D.TRS_SEC
			, D.ITM_CD
	        , D.COM_PLDSEC
	        , E.PLS_RMK
	  HAVING  D.ITM_CD > ''
]]>
</select>

<select id="selectAsSearchDetailInfo" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPSigongSearchDetailInfo">         
<![CDATA[ 
	SELECT 
			 A.BMT_ITEM + '-'+ A.COL_CD AS ITMCD_COL  
			,B.BMT_NM 					AS ITM_NM	
			,'AS'						AS COM_PLDSEC	
			,A.AST_QQTY					AS QTY
			,A.BMT_SAMT					AS AMT
	  FROM TA_ASTITEM A WITH (NOLOCK)
 LEFT JOIN TT_BOMMST B ON 1=1 AND A.BMT_ITEM	= B.BMT_ITEM
							  AND A.COL_CD		= B.COL_CD 
	 WHERE 1=1
	   AND ( A.RPT_NO = SUBSTRING(#{orm_no}, 1, 13) AND A.RPT_SEQ = SUBSTRING(#{orm_no}, 14, 15)) 
	   AND ( A.RPT_NO > '' AND A.RPT_SEQ > '' )
]]>
</select>

<select id="selectNetKmAllowance" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPNetKmAllowance">        
<![CDATA[ 
	SELECT
		REF_1 AS NETKM_ALLOWANCE
	  FROM 	TT_COMCD WITH(NOLOCK)
	 WHERE CCD_CD = 'C72000'
]]>
</select>

<select id="selectSelectStmList" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPSigongStmList">         
<![CDATA[ 
SELECT STM_NO
      ,STM_NM
      ,COM_SCD
      ,STI_CD
      ,STI_CD + '_' + ISNULL(STM_NO,'01') AS UNIQUE_STM_NO
  FROM TC_STMEMBER WITH (NOLOCK)
 WHERE COM_SCD = #{com_scd}
   AND STI_CD = #{sti_cd}
]]>
</select>

	<update id="updateStmNoResmst" parameterType="HashMap">
	<![CDATA[
	    UPDATE TC_RESMST SET
		      STM_NO = #{stm_no}
		WHERE REM_DT= CAST( #{rem_dt} AS VARCHAR)
		  AND REM_SEQ= CAST( #{rem_seq} AS VARCHAR)
	]]>
	</update> 
	
	<update id="updateStmNoTcPlanmst" parameterType="HashMap">
	<![CDATA[
		UPDATE TC_PLANMST
		   SET STM_NO    = #{stm_no}
	     WHERE 1=1	
	       AND PLM_NO = CAST( #{plm_no} AS VARCHAR)
	]]>
	</update> 
 
<select id="selectSelectCooperationList" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPCooperationList">         
<![CDATA[ 
	SELECT
		TCR.PLM_CDT AS PLM_CDT,
		TCR.STI_CD AS STI_CD,
		(SELECT TCS.STI_NM FROM TC_STINF TCS WITH (NOLOCK) WHERE TCS.STI_CD = TCR.STI_CD AND TCS.COM_SCD = TCR.COM_SCD ) AS STI_NM,
		TCR.ORM_NO AS ORM_NO,
		TCR.ORM_NM AS ORM_NM,
		(SELECT TTC.CCD_NM FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CCD_CD = TCR.COM_BRAND) AS COM_BRAND,
		TCR.PLM_NO AS PLM_NO
	  FROM TC_PLANMST TCR WITH (NOLOCK), TC_STINF TCS WITH (NOLOCK)
	 WHERE TCR.PLM_CDT BETWEEN #{fdt} AND #{tdt}
	    AND TCR.COM_SCD = #{com_scd}
	    AND TCR.STI_CD = #{sti_cd}
	    AND TCR.COM_PLMFG = 'C104'
	    AND TCR.COM_AGSEC <> 'C02P'
	    AND TCR.ORM_NM LIKE #{orm_nm}
		AND TCR.STI_CD = TCS.STI_CD
		AND TCR.COM_SCD = TCS.COM_SCD
]]>
</select>
     
<insert id="insertCooperationRequestMaster" parameterType="HashMap">
<![CDATA[ 
    INSERT INTO TC_COOPERATION_M
	(
       PLM_NO,
       PLM_CDT,
       STI_CD,
       REQ_AMT,
       USR_CD,
       SYS_DT,
       FST_USR_CD,
       FST_SYS_DT
	)
	VALUES 
	(
       #{o_plm_no},
       #{plm_cdt},
       #{sti_cd},
       #{req_amt},
       #{user_id},
       GETDATE(),
       #{user_id},
       GETDATE()
	)
]]>
</insert>

<insert id="insertCooperationRequestDetail" parameterType="HashMap">
<![CDATA[ 
    INSERT INTO TC_COOPERATION_D
	(
		O_PLM_NO,
		PLM_NO,
        PLM_CDT,
        STI_CD,
        REQ_AMT,
        REQ_STAT,
        USR_CD,
        SYS_DT,
        FST_USR_CD,
        FST_SYS_DT
	)
	
	SELECT
			AAA.O_PLM_NO,
			AAA.PLM_NO,
			AAA.PLM_CDT,
			AAA.STI_CD,
			AAA.REQ_AMT,
			AAA.REQ_STAT,
			AAA.USR_CD,
			AAA.SYS_DT,
			AAA.FST_USR_CD,
			AAA.FST_SYS_DT
	  FROM
	  (
	  	SELECT
	  		#{o_plm_no} as O_PLM_NO, AA.DATA AS PLM_NO, BB.DATA AS STI_CD, CC.DATA AS PLM_CDT, DD.DATA AS REQ_AMT, 'N' AS REQ_STAT, #{user_id} AS USR_CD, GETDATE() AS SYS_DT, #{user_id} AS FST_USR_CD, GETDATE() AS FST_SYS_DT
	  	  FROM  dbo.fnSplit(#{plm_no_arr}) AA, dbo.fnSplit(#{sti_cd_arr}) BB, dbo.fnSplit(#{plm_cdt_arr}) CC, dbo.fnSplit(#{req_amt_arr}) DD
	  	 WHERE AA.SEQNO = BB.SEQNO
	   	   AND BB.SEQNO = CC.SEQNO
	       AND CC.SEQNO = DD.SEQNO
	  ) AAA 
	GROUP BY AAA.O_PLM_NO, AAA.PLM_NO, AAA.PLM_CDT, AAA.STI_CD, AAA.REQ_AMT, AAA.STI_CD,  AAA.REQ_STAT, AAA.USR_CD, AAA.SYS_DT, AAA.FST_USR_CD, AAA.FST_SYS_DT	
		
]]>
</insert>

<select id="selectReqCooperationList" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPReqCooperationList">         
<![CDATA[

	SELECT A.PLM_NO, A.PLM_CDT, A.ORM_NM, A.COM_BRAND, A.REQ_AMT, SUM(A.REQ_AMT_DETAIL) REQ_AMT_DETAIL, SUM(A.REQ_STAT) REQ_STAT_M
	  FROM (
	 SELECT
			TCCM.PLM_NO AS PLM_NO,
			TCCM.PLM_CDT AS PLM_CDT,
			( SELECT TCP.ORM_NM FROM TC_PLANMST TCP WITH (NOLOCK) WHERE TCP.PLM_NO = TCCM.PLM_NO ) AS ORM_NM,
			( SELECT TTC.CCD_NM FROM TT_COMCD TTC WITH (NOLOCK) WHERE CCD_CD = ( SELECT TCP.COM_BRAND FROM TC_PLANMST TCP WITH (NOLOCK) WHERE TCP.PLM_NO = TCCM.PLM_NO ) ) AS COM_BRAND,
			TCCM.REQ_AMT AS REQ_AMT,
			TCCD.REQ_AMT AS REQ_AMT_DETAIL,
			CASE TCCD.REQ_STAT WHEN 'N' THEN 1
		                   WHEN 'Y' THEN 0
						   WHEN 'C' THEN -1 END AS REQ_STAT
		FROM TC_COOPERATION_M TCCM WITH (NOLOCK), TC_COOPERATION_D TCCD WITH (NOLOCK)
		WHERE TCCM.PLM_NO = TCCD.O_PLM_NO
		  AND TCCM.STI_CD = #{sti_cd}
		  AND TCCM.PLM_CDT BETWEEN #{fdt} AND #{tdt}
		  ) A
	 GROUP BY A.PLM_NO, A.PLM_CDT, A.ORM_NM, A.COM_BRAND, A.REQ_AMT

]]>
</select>

<select id="selectReqDetailCooperationList" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPReqCooperationList">         
<![CDATA[ 

	 SELECT
		TCCD.O_PLM_NO AS O_PLM_NO,
		TCCD.PLM_NO AS PLM_NO,
		TCCD.PLM_CDT AS PLM_CDT,
		( SELECT TCP.ORM_NM FROM TC_PLANMST TCP WITH (NOLOCK) WHERE TCP.PLM_NO = TCCD.PLM_NO ) AS ORM_NM,
		( SELECT TTC.CCD_NM FROM TT_COMCD TTC WITH (NOLOCK) WHERE CCD_CD = ( SELECT TCP.COM_BRAND FROM TC_PLANMST TCP WITH (NOLOCK) WHERE TCP.PLM_NO = TCCD.PLM_NO ) ) AS COM_BRAND,
		TCCD.REQ_AMT AS REQ_AMT,
		TCCD.STI_CD AS STI_CD,
		(SELECT TCS.STI_NM FROM TC_STINF TCS WITH (NOLOCK) WHERE TCS.STI_CD = TCCD.STI_CD AND TCS.STI_CD = ( SELECT TCP.STI_CD FROM TC_PLANMST TCP WITH (NOLOCK) WHERE TCP.PLM_NO = TCCD.PLM_NO ) ) AS STI_NM,
		( CASE TCCD.REQ_STAT WHEN 'N' THEN '요청' WHEN 'Y' THEN '승인' ELSE '정산확정' END ) AS REQ_STAT
	FROM TC_COOPERATION_D TCCD WITH (NOLOCK)
	WHERE TCCD.O_PLM_NO = #{o_plm_no}
	
]]>
</select>

<update id="updateReqCooperationCancel" parameterType="HashMap">
<![CDATA[
	DELETE
	 FROM TC_COOPERATION_D
	WHERE O_PLM_NO = #{o_plm_no}
	  AND PLM_NO = #{plm_no}
]]>
</update> 

<select id="selectApplyCooperationList" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.erp.ERPReqCooperationList">         
<![CDATA[ 
	SELECT
		TCCD.O_PLM_NO AS O_PLM_NO,
		TCCD.PLM_NO AS PLM_NO,
		TCCD.PLM_CDT AS PLM_CDT,
		( SELECT TCP.ORM_NM FROM TC_PLANMST TCP WITH (NOLOCK) WHERE TCP.PLM_NO = TCCD.PLM_NO ) AS ORM_NM,
		( SELECT TTC.CCD_NM FROM TT_COMCD TTC WITH (NOLOCK) WHERE CCD_CD = ( SELECT TCP.COM_BRAND FROM TC_PLANMST TCP WITH (NOLOCK) WHERE TCP.PLM_NO = TCCD.PLM_NO ) ) AS COM_BRAND,
		TCCD.REQ_AMT AS REQ_AMT,
		( SELECT TCP.STI_CD FROM TC_PLANMST TCP WITH (NOLOCK) WHERE TCP.PLM_NO = TCCD.O_PLM_NO ) AS O_STI_CD,
		(SELECT TCS.STI_NM FROM TC_STINF TCS WITH (NOLOCK) WHERE TCS.STI_CD = TCCD.STI_CD AND TCS.STI_CD = ( SELECT TCP.STI_CD FROM TC_PLANMST TCP WITH (NOLOCK) WHERE TCP.PLM_NO = TCCD.O_PLM_NO ) ) AS O_STI_NM,
		( CASE TCCD.REQ_STAT WHEN 'N' THEN '승인대기' WHEN 'Y' THEN '승인완료' ELSE '정산확정' END ) AS REQ_STAT
	FROM TC_COOPERATION_D TCCD WITH (NOLOCK)
	WHERE TCCD.PLM_CDT BETWEEN #{fdt} AND #{tdt}
	  AND TCCD.STI_CD = #{sti_cd}
]]>
</select> 

<update id="updateReqCooperationApply" parameterType="HashMap">
<![CDATA[
	UPDATE TC_COOPERATION_D SET REQ_STAT = 'Y', SYS_DT = GETDATE()
	 FROM TC_COOPERATION_D
	WHERE O_PLM_NO = #{o_plm_no}
	  AND PLM_NO = #{plm_no}
]]>
</update> 

<insert id="insertCooperationOriginalJungsan" parameterType="HashMap">
<![CDATA[ 

		INSERT INTO TC_PLANDTL
		(
		PLM_NO /* 시공번호 */
		,COM_PLDSEC /* 구분 */
		,ORD_SSEQ /* 좌수 AAA , 기타추가비용 07P*/
		,ORD_ISEQ /* 순번 구분건마다 001+ */
		,PLD_EQTY /* 예상수량 */
		,PLD_FQTY /* 확정수량 */
		,PLD_FAMT /* 공장도가 */
	    ,PLD_CFAMT /* 확정비용 [기타추가비용 ] */
		,COM_RDSEC /* 시공결과구분 */
		,USR_CD /* */
		,SYS_DT /* */
		,COM_ACD /* 정산세부항목코드 */
		,COM_VFSEC /* 업체FROM구분 */
		,COM_VTSEC /* 업체TO구분 */		
		)
		VALUES
		(
		#{o_plm_no}
		,'C0927'
		,'07P'
		,(SELECT RIGHT('000' + CONVERT(VARCHAR(3), isnull(MAX(ORD_ISEQ), 0) + 1) , 3)
		FROM TC_PLANDTL WITH (NOLOCK) WHERE 1=1 AND PLM_NO = #{o_plm_no} AND COM_PLDSEC =
		'C0927' AND ORD_SSEQ = '07P')
		,1 
		,1 
		,-#{req_amt}
		,-#{req_amt}
		,'C13Y'
		,'SYSTEM'
		,GETDATE()
		,'C01207'
		,'C2402'
		,'C2501'
		)

]]>
</insert>

<insert id="insertCooperationOriginalJungsanDetail" parameterType="HashMap">
<![CDATA[ 

		INSERT INTO TC_PLANDTL
		(
		PLM_NO /* 시공번호 */
		,COM_PLDSEC /* 구분 */
		,ORD_SSEQ /* 좌수 AAA , 기타추가비용 07P*/
		,ORD_ISEQ /* 순번 구분건마다 001+ */
		,PLD_EQTY /* 예상수량 */
		,PLD_FQTY /* 확정수량 */
		,PLD_FAMT /* 공장도가 */
	    ,PLD_CFAMT /* 확정비용 [기타추가비용 ] */
		,COM_RDSEC /* 시공결과구분 */
		,USR_CD /* */
		,SYS_DT /* */
		,COM_ACD /* 정산세부항목코드 */
		,COM_VFSEC /* 업체FROM구분 */
		,COM_VTSEC /* 업체TO구분 */		
		)
		VALUES
		(
		#{o_plm_no}
		,'C0927'
		,'07P'
		,(SELECT RIGHT('000' + CONVERT(VARCHAR(3), isnull(MAX(ORD_ISEQ), 0) + 1) , 3)
		FROM TC_PLANDTL WITH (NOLOCK) WHERE 1=1 AND PLM_NO = #{o_plm_no} AND COM_PLDSEC =
		'C0927' AND ORD_SSEQ = '07P')
		,1 
		,1 
		,#{req_amt}
		,#{req_amt}
		,'C13Y'
		,'SYSTEM'
		,GETDATE()
		,'C01207'
		,'C2402'
		,'C2501'
		)

]]>
</insert>

<insert id="insertCooperationReqJungsan" parameterType="HashMap">
<![CDATA[
 
	INSERT INTO TC_ACTLIST
		(
			PLM_NO,
			COM_ASEC,
			COM_ACD,
			COM_SVND,
			COM_AGSEC,
			COM_DPSEC,
			ACL_VFROM,
			ACL_VTO,
			COM_VFSEC,
			COM_VTSEC,
			ACL_AMT,
			COM_SCD,
			COM_CTSEC,
			PLM_CDT,
			ACL_DT,
			ACL_CMPYN,
			ACL_RMK,
			USR_CD,
			SYS_DT,
			COM_CESEC,
			COM_BRAND
		)
		
		SELECT
			AAA.PLM_NO,
			AAA.COM_ASEC,
			AAA.COM_ACD,
			AAA.COM_SVND,
			AAA.COM_AGSEC,
			AAA.COM_DPSEC,
			AAA.ACL_VFROM,
			AAA.ACL_VTO,
			AAA.COM_VFSEC,
			AAA.COM_VTSEC,
			AAA.ACL_AMT,
			AAA.COM_SCD,
			AAA.COM_CTSEC,
			AAA.PLM_CDT,
			AAA.ACL_DT,
			AAA.ACL_CMPYN,
			AAA.ACL_RMK,
			AAA.USR_CD,
			AAA.SYS_DT,
			AAA.COM_CESEC,
			AAA.COM_BRAND
		  FROM
		  (
		  	SELECT
		  		AA.DATA AS PLM_NO,
		  		'C0927' AS COM_ASEC,
		  		'C01207' AS COM_ACD,
		  		'C21B' AS COM_SVND,
				( SELECT TCP.COM_AGSEC FROM TC_PLANMST TCP WITH (NOLOCK) WHERE PLM_NO = AA.DATA ) AS COM_AGSEC,
				'C07P' AS COM_DPSEC,
				'C21B' AS ACL_VFROM,
				( SELECT TCP.STI_CD FROM TC_PLANMST TCP WITH (NOLOCK) WHERE PLM_NO = AA.DATA ) AS ACL_VTO,
				'C2402' AS COM_VFSEC,
				'C2501' AS COM_VTSEC,
				BB.DATA AS ACL_AMT,
				( SELECT TCP.COM_SCD FROM TC_PLANMST TCP WITH (NOLOCK) WHERE PLM_NO = AA.DATA ) AS COM_SCD,
				( SELECT TCP.COM_CTSEC FROM TC_PLANMST TCP WITH (NOLOCK) WHERE PLM_NO = AA.DATA ) AS COM_CTSEC,
				( SELECT TCP.PLM_CDT FROM TC_PLANMST TCP WITH (NOLOCK) WHERE PLM_NO = AA.DATA ) AS PLM_CDT,
				( SELECT TCP.PLM_CDT FROM TC_PLANMST TCP WITH (NOLOCK) WHERE PLM_NO = AA.DATA ) AS ACL_DT,
				'N' AS ACL_CMPYN,
				'기타추가비용 지급정산금액 = ' + BB.DATA AS ACL_RMK,
				#{user_id} AS USR_CD,
				GETDATE() AS SYS_DT,
				#{user_id} AS FST_USR_CD,
				GETDATE() AS FST_SYS_DT,
				'C292' AS COM_CESEC,
				( SELECT TCP.COM_BRAND FROM TC_PLANMST TCP WITH (NOLOCK) WHERE PLM_NO = AA.DATA  ) AS COM_BRAND
		  	  FROM  dbo.fnSplit(#{plm_no_arr}) AA, dbo.fnSplit(#{req_amt_arr}) BB
		  	 WHERE AA.SEQNO = BB.SEQNO
		  ) AAA
		GROUP BY AAA.PLM_NO, AAA.COM_ASEC, AAA.COM_ACD, AAA.COM_SVND, AAA.COM_AGSEC, AAA.COM_DPSEC, AAA.ACL_VFROM, AAA.ACL_VTO, AAA.COM_VFSEC, AAA.COM_VTSEC, AAA.ACL_AMT, AAA.COM_SCD, AAA.COM_CTSEC, AAA.PLM_CDT, AAA.ACL_DT, AAA.ACL_CMPYN, AAA.ACL_RMK, AAA.USR_CD, AAA.SYS_DT,	AAA.COM_CESEC, AAA.COM_BRAND
	
]]>
</insert> 

<insert id="insertCooperationReqJungsan_" parameterType="HashMap">
<![CDATA[ 
	INSERT INTO TC_ACTLIST
	(
		PLM_NO,
		COM_ASEC,
		COM_ACD,
		COM_SVND,
		COM_AGSEC,
		COM_DPSEC,
		ACL_VFROM,
		ACL_VTO,
		COM_VFSEC,
		COM_VTSEC,
		ACL_AMT,
		COM_SCD,
		COM_CTSEC,
		PLM_CDT,
		ACL_DT,
		ACL_CMPTN,
		ACL_RMK,
		USR_CD,
		SYS_DT,
		COM_CESEC,
		COM_BRAMD
	)
	
	SELECT
		AAA.PLM_NO,
		AAA.COM_ASEC,
		AAA.COM_ACD,
		AAA.COM_SVND,
		AAA.COM_AGSEC,
		AAA.COM_DPSEC,
		AAA.ACL_VFROM,
		AAA.ACL_VTO,
		AAA.COM_VFSEC,
		AAA.COM_VTSEC,
		AAA.ACL_AMT,
		AAA.COM_SCD,
		AAA.COM_CTSEC,
		AAA.PLM_CDT,
		AAA.ACL_DT,
		AAA.ACL_CMPTN,
		AAA.ACL_RMK,
		AAA.USR_CD,
		AAA.SYS_DT,
		AAA.COM_CESEC,
		AAA.COM_BRAMD
	  FROM
	  (
	  	SELECT
	  		AA.DATA AS PLM_NO,
	  		'C0927' AS COM_ASEC,
	  		'C01207' AS COM_ACD,
	  		'C21B' AS COM_SVND, 
			( SELECT TCP.COM_AGSEC FROM TC_PLANMST TCP WITH (NOLOCK) WHERE PLM_NO = #{plm_no} ) AS COM_AGSEC,
			'C07P' AS COM_DPSEC,
			'C21B' AS ACL_VFROM, 
			( SELECT TCP.STI_CD FROM TC_PLANMST TCP WITH (NOLOCK) WHERE PLM_NO = #{plm_no} ) AS ACL_VTO,
			'C2402' AS COM_VFSEC,
			'C2501' AS COM_VFSEC,
			BB.DATA AS ACL_AMT,
			( SELECT TCP.COM_SCD FROM TC_PLANMST TCP WITH (NOLOCK) WHERE PLM_NO = #{plm_no} ) AS COM_SCD,
			( SELECT TCP.COM_CTSEC FROM TC_PLANMST TCP WITH (NOLOCK) WHERE PLM_NO = #{plm_no} ) AS COM_CTSEC,
			( SELECT TCP.PLM_CDT FROM TC_PLANMST TCP WITH (NOLOCK) WHERE PLM_NO = #{plm_no} ) AS PLM_CDT,
			( SELECT TCP.PLM_CDT FROM TC_PLANMST TCP WITH (NOLOCK) WHERE PLM_NO = #{plm_no} ) AS ACL_DT,
			'N' AS ACL_CMPTN,
			'기타추가비용 지급정산금액 = ' + BB.DATA AS ACL_RMK,
			#{user_id} AS USR_CD,
			GETDATE() AS SYS_DT,
			#{user_id} AS FST_USR_CD,
			GETDATE() AS FST_SYS_DT
	  	  FROM  dbo.fnSplit(#{plm_no_arr}) AA, dbo.fnSplit(#{req_amt_arr}) BB
	  	 WHERE AA.SEQNO = BB.SEQNO
	  ) AAA 
	GROUP BY AAA.PLM_NO, AAA.COM_ASEC, AAA.COM_ACD, AAA.COM_SVND, AAA.COM_AGSEC, AAA.COM_DPSEC, AAA.ACL_VFROM, AAA.ACL_VTO, AAA.COM_VFSEC, AAA.COM_VTSEC, AAA.ACL_AMT, AAA.COM_SCD, AAA.COM_CTSEC, AAA.PLM_CDT, AAA.ACL_DT, AAA.ACL_CMPTN, AAA.ACL_RMK, AAA.USR_CD, AAA.SYS_DT,	AAA.COM_CESEC, AAA.COM_BRAMD

]]>
</insert> 

<update id="updateReqCooperationJungsan" parameterType="HashMap">
<![CDATA[
	UPDATE TC_COOPERATION_D SET REQ_STAT = 'C', SYS_DT = GETDATE()
	 FROM TC_COOPERATION_D
	WHERE O_PLM_NO = #{o_plm_no}
]]>
</update> 

<select id="selectMasterDeleteYn" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.DataResult">        
<![CDATA[ 
	SELECT ISNULL(COUNT(*), 0) AS VALUE1
	   FROM TC_COOPERATION_D WITH (NOLOCK)
	  WHERE O_PLM_NO = #{o_plm_no} 

]]>
</select>

<update id="updateReqCooperationMasterCancel" parameterType="HashMap">
<![CDATA[
	DELETE FROM TC_COOPERATION_M
	WHERE PLM_NO = #{o_plm_no}
]]>
</update>

<select id="selectCooperationMasterYn" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.DataResult">        
<![CDATA[ 
	SELECT ISNULL(COUNT(*), 0) AS VALUE1
	   FROM TC_COOPERATION_M WITH (NOLOCK)
	  WHERE PLM_NO = #{o_plm_no} 

]]>
</select>

<select id="getSigongBrand" parameterType="java.util.HashMap" resultType="com.fursys.mobilecm.vo.DataResult">        
<![CDATA[

	SELECT
		ISNULL(TCP.COM_BRAND, '') AS DATA1
	  FROM TC_PLANMST TCP WITH (NOLOCK)
	 WHERE TCP.PLM_NO = #{plm_no}

]]>
</select>

<select id="getSigongOrmNm" parameterType="java.util.HashMap" resultType="com.fursys.mobilecm.vo.DataResult">        
<![CDATA[

	SELECT
		ISNULL(TCP.ORM_NM, '') AS DATA1
	  FROM TC_PLANMST TCP WITH (NOLOCK)
	 WHERE TCP.PLM_NO = #{plm_no}

]]>
</select>

<select id="getSigongOrmHdphone" parameterType="java.util.HashMap" resultType="com.fursys.mobilecm.vo.DataResult">        
<![CDATA[

	SELECT
		ISNULL(B.ORM_HDPHONE, '') AS DATA1
	  FROM TC_PLANMST A WITH (NOLOCK), TO_ORDMAS B WITH(NOLOCK)
	WHERE A.ORM_NO = B.ORM_NO
	  AND A.PLM_NO = #{plm_no}

]]>
</select>

<select id="getSigongSofaYn" parameterType="java.util.HashMap" resultType="com.fursys.mobilecm.vo.DataResult">        
<![CDATA[

SELECT
	ISNULL(( CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END ), 'N') AS DATA1
  FROM TC_PLANMST A WITH (NOLOCK), TO_ORDMAS B WITH (NOLOCK), TO_ORDDET C WITH (NOLOCK), TT_ITMMST D WITH (NOLOCK)
 WHERE A.ORM_NO = B.ORM_NO
   AND B.ORM_NO = C.ORM_NO
   AND C.ITM_CD = D.ITM_CD
   AND C.COL_CD = D.COL_CD
   AND D.COM_FMTCD1 = 'T04I83'
   AND A.PLM_NO = #{plm_no}
]]>
</select>

<select id="getSigongAgtCd" parameterType="java.util.HashMap" resultType="com.fursys.mobilecm.vo.DataResult">        
<![CDATA[

SELECT
	ISNULL((SELECT TSC.CEP_MP 
	          FROM TO_ORDMAS TOO WITH (NOLOCK), TS_CEMPLOYEE TSC WITH (NOLOCK) 
	         WHERE A.ORM_NO = TOO.ORM_NO
	           AND TSC.CEP_CD = A.ORM_AGTEMP ), '') AS DATA1,
	A.ORM_NM AS DATA2,
	( SELECT TCS.STI_NM FROM TC_STINF TCS WITH (NOLOCK) WHERE TCS.COM_SCD = A.COM_SCD AND TCS.STI_CD = A.STI_CD ) AS DATA3
  FROM TC_PLANMST A WITH (NOLOCK)
 WHERE A.PLM_NO = #{plm_no}
 
]]>
</select>

<select id="searchIosFileYn" parameterType="java.util.HashMap" resultType="com.fursys.mobilecm.vo.DataResult">        
<![CDATA[

	SELECT 
		( CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END ) AS DATA1
	FROM TO_FORMMAS_NIOS_IMG IOS WITH (NOLOCK)
	WHERE IOS.FRM_NO = ( SELECT TOO.FRM_NO FROM TO_ORDMAS TOO WITH (NOLOCK) WHERE TOO.ORM_NO = #{file_id} )
	  AND ( ISNULL(CONVERT(VARCHAR,IMG_CNT),'') = 'IOS' OR ISNULL(CONVERT(VARCHAR,IMG_CNT),'') BETWEEN '1' AND '30' )
	  AND IOS.IMG_CNT <> 0
 
]]>
</select>
 
<select id="selectSigongFileListCadYn" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.DataResult">         
<![CDATA[ 
	
	SELECT 
		( CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END ) AS DATA1
	FROM TN_COMM_FILE A WITH (NOLOCK)
	WHERE A.DATA_KEY = #{file_id}
]]> 
</select>

<select id="selectAsReqBasicInfomation" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.DataResult">        
<![CDATA[

	SELECT
		TCP.COM_AGSEC AS DATA1,
		TCP.COM_SCD AS DATA2,
		TCP.COM_BRAND AS DATA3, 
		TCP.STI_CD AS DATA4,
		TCP.TOWN_CD AS DATA5
	  FROM TC_PLANMST TCP WITH (NOLOCK)
	 WHERE TCP.PLM_NO = #{plm_no}

]]>
</select>

<select id="selectAsReqBasicInfomation2" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.DataResult">        
<![CDATA[

SELECT 
		 CC.ROAD_ADDR AS DATA1,
		 BB.ORM_GPOST AS DATA2,
		 BB.ORM_GADDR AS DATA3,
		 BB.AGT_CD AS DATA4,
		 BB.VND_NM AS DATA5
  FROM 
		(SELECT TOP 1 ROAD_ADDR FROM TC_ROADZIP WITH (NOLOCK) WHERE 1=1  AND ZIP_CD = '16954') CC,			
		(SELECT  
				A.ORM_GPOST AS ORM_GPOST
				,A.ORM_GADDR AS ORM_GADDR
				,A.AGT_CD AS AGT_CD
				,ISNULL(B.VND_NM,'') AS VND_NM
  		   FROM TC_PLANMST A WITH (NOLOCK) ,TT_VENDOR B WITH (NOLOCK)
 		  WHERE A.AGT_CD 	= B.VND_CD 
   		    AND PLM_NO 		= #{plm_no}
		)BB  

]]>
</select>

<select id="selectExcuteAsTeamInfo" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.DataResult">        
<![CDATA[

 SELECT TOP 1 A.STI_CD  AS DATA1
       ,C.STI_NM AS DATA2
       ,C.COM_SCD AS DATA3
  FROM TC_BRANDITM A with (nolock)
       ,TA_TOWND B with (nolock)
       ,TC_STINF C with (nolock)
 WHERE A.COM_AGSEC = B.COM_AGSEC
   AND A.COM_BRAND = B.COM_BRAND
   AND A.STI_CD    = B.STI_CD
   AND A.STI_CD    = C.STI_CD
   AND A.COM_SCD   = C.COM_SCD
   AND A.COM_AGSEC = #{com_agsec}  
   AND A.COM_BRAND = #{com_brand}
   AND B.TOWN_CD   = #{town_cd}
   AND C.STI_RANK = 'Y'

]]>
</select>


<insert id="insertSigongMigeulAsRequest" parameterType="HashMap">
<![CDATA[
 
INSERT INTO TA_RPTREQ
		(
		 RPT_NO
		,RPT_SEQ
		,RPT_DT
		,CTM_CD
		,CTM_ZIP
		,CTM_ADDR
		,CTM_ADDR2
		,COM_AGSEC
		,STI_CD
		,USR_ID
		,SYS_DT
		,REMARK
		,FST_USR
		,FST_SYS_DT
		,COM_ATSEC
		,COM_RPSEC
		,CTM_TYPE
		,CTM_OCD
		,CTM_ONM
		,CTM_NM
		,CTM_TEL
		,CTM_HP
		,CTM_EMAIL
		,VND_SCD
		,VND_RPTCD
		,VND_RPTNM
		,VND_SNM
		,RPT_QDT
		,COM_SCD
		,RPT_USRNM
		,RPT_QNM
		,RPT_SCD
		,RPT_RST_ACTTM
		,RPT_QTM_GUBUN
		,RPT_QTM
		,COM_PKSEC
		,RPT_STARTTM
		,RPT_ENDTM
		,COM_SPROG
		,RPT_YN
		,FILE_ID
		,RPT_DESC
		,COM_BRAND
		,TOWN_CD
		,ORD_NO 
		,RPT_QYN
		,ITM_GROUP
		,ACT_STICD
		,TRS_YN
		,RPT_USRID		
		,PLM_NO
		,RPT_URG		
		) 
	VALUES
		(
		 #{new_rpt_no}
		,'01'									
		,CONVERT(CHAR(8), GETDATE(), 112)		
		,(SELECT TOO.ORM_PURCST 
		    FROM TO_ORDMAS TOO WITH (NOLOCK)
		   WHERE TOO.ORM_NO = (SELECT TCP.ORM_NO FROM TC_PLANMST TCP WITH (NOLOCK) WHERE TCP.PLM_NO = #{plm_no} ) )							
		,#{orm_gpost}
		,#{orm_gaddr}
		,(SELECT TCP.ADDR_DTL FROM TC_PLANMST TCP WITH (NOLOCK) WHERE TCP.PLM_NO = #{plm_no} )
		,#{com_agsec}
		,#{as_sti_cd}
		,#{sti_cd}
		,GETDATE()
		,NULL
		,#{sti_cd}
		,GETDATE()
		,'A11003'
		, CASE #{inconsistent_yn} WHEN 'Y' THEN 'A12011' ELSE 'A12004' END
		,''	
		,''	
		,''
		,LEFT((SELECT TCP.ORM_NM FROM TC_PLANMST TCP WITH (NOLOCK) WHERE TCP.PLM_NO = #{plm_no} ), 30)
		,(SELECT TCP.ORM_GEMPTEL FROM TC_PLANMST TCP WITH (NOLOCK) WHERE TCP.PLM_NO = #{plm_no} )
		,(SELECT TCP.ORM_HDPHONE FROM TC_PLANMST TCP WITH (NOLOCK) WHERE TCP.PLM_NO = #{plm_no} )
		,''
		,#{agt_cd}
		,#{agt_cd}
		,ISNULL(#{vnd_nm},'ANONY1')
		,ISNULL(#{vnd_nm},'대리점불명')
		,#{req_as_dt}
		,#{as_com_scd}
		,#{as_sti_nm}
		,#{as_sti_nm}
		,#{as_com_scd}
		,#{as_sti_cd}
		,'C4133'
		,'C4133'
        ,'R03002'
        ,''
        ,''
        ,'A17001'
		,'N'
	    ,''
		,#{as_req_remark}
		,#{com_brand}
		,#{town_cd}
		,''
		,'Y'
		,'A94002'
		,#{as_sti_cd}
		,'Y'
		,#{sti_cd}
		,#{plm_no}
		,#{rpt_urg}
		
		)	 
]]>
</insert> 
 
<select id="executePraFaRptno" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.DataResult">
<![CDATA[
	
	execute dbo.PRA_FA_RPTNO_CM;1 @P_COM_AGSEC = #{com_agsec}, @P_WKSEC = 'C08A01'
	
]]>
</select>

<select id="selectExcuteAsReqBasicInfo" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.DataResult">        
<![CDATA[
	SELECT
		TCP.ORM_NM AS DATA1,
		( SELECT TCS.STI_NM FROM TC_STINF TCS WITH (NOLOCK) WHERE TCS.COM_SCD = TCP.COM_SCD AND TCS.STI_CD = TCP.STI_CD ) AS DATA2,
		TCP.PLM_CDT AS DATA3,
		ISNULL(TCP.MOB_REMARK, '') AS DATA4,
		TCP.ORM_NO AS DATA5
	  FROM TC_PLANMST TCP WITH (NOLOCK)
	 WHERE TCP.PLM_NO = #{plm_no}

]]>
</select>

<update id="updateSigongAsConfirmInform" parameterType="HashMap">
<![CDATA[
	UPDATE TC_PLANDTL SET COM_UNPSEC = 'C23A', SYS_DT = GETDATE()
	WHERE PLM_NO = #{plm_no}
	   AND COM_RDSEC ='C13N'
	   AND COM_PLDSEC IN('C090','C091','C092','C093','C094','C095','C096','C0930','C09A')

]]>
</update>


<select id="selectSigongReqBasicInfomation" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.DataResult">        
<![CDATA[

	SELECT
		TCP.COM_AGSEC AS DATA1,
		TCP.COM_BRAND AS DATA2, 
		TCP.COM_SCD AS DATA3,
		TCP.STI_CD AS DATA4,
		TCP.ORM_NO AS DATA5,
		TCP.PLM_CDT AS DATA6
	  FROM TC_PLANMST TCP WITH (NOLOCK)
	 WHERE TCP.PLM_NO = #{plm_no}

]]>
</select>

<select id="selectSigongReqBasicInfomation2" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.DataResult">        
<![CDATA[

	SELECT
		TCP.AGT_CD AS DATA1,
		TCP.ORM_GPOST AS DATA2, 
		TCP.TOWN_CD AS DATA3,
		TCP.ORM_GADDR AS DATA4,
		TCP.PLM_CDT AS DATA5
	  FROM TC_PLANMST TCP WITH (NOLOCK)
	 WHERE TCP.PLM_NO = #{plm_no}

]]>
</select>

<select id="executePraFaAseqrem" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.DataResult">
<![CDATA[
	
	DECLARE @PLM_NO VARCHAR(20)
	DECLARE @RET_CODE VARCHAR(20)    
           SET @RET_CODE = ''
	EXECUTE PRA_FA_ASEQREM #{org_com_agsec}, '', #{req_resigong_dt}, 'PLM', NULL, @RET_CODE = @PLM_NO OUTPUT
	SELECT @PLM_NO AS DATA1
	
]]>
</select>


<insert id="insertSigongMigeulReRequest" parameterType="HashMap">
<![CDATA[
	INSERT INTO TC_PLANMST 
			(
				 PLM_NO
				,ORM_NO
				,PRJ_CD
				,COM_SCD
				,COM_AGSEC
				,AGT_CD
				,COM_CTSEC
				,STI_CD
				,STM_NO
				,SAC_CD
				,ORM_ORDDT
				,ORM_RDT
				,PLM_CDT
				,PLM_FIXEDT
				,PLM_ENDDT
				,ORM_PURCST
				,ORM_NM
				,ORM_GEMP
				,DET_CD
				,ORM_GEMPTEL
				,ORM_HDPHONE
				,PLM_PTM
				,PLM_FTM
				,PLM_ETM
				,COM_PLMFG
				,ORM_GPOST
				,ORM_GADDR
				,ORM_GSPC
				,PLM_EVT
				,PLM_CMPYN
				,PLM_ITR
				,ORM_SALEMP
				,ORM_AGTEMP
				,PLM_HCALLYN
				,PLM_RMK
				,COM_RMFG
				,COM_UNMSEC
				,USR_CD
				,SYS_DT 
				,PLM_RCSEC
				,PLM_PNO
				,ORM_GOOD
				,PLM_CSEC 
				,FST_USR
				,FST_SYS_DT
			)
	
		SELECT 
				 #{new_plm_no}
				,ORM_NO
				,PRJ_CD
				,COM_SCD
				,COM_AGSEC
				,AGT_CD
				,COM_CTSEC
				,STI_CD
				,STM_NO
				,SAC_CD
				,ORM_ORDDT
				,ORM_RDT
				,#{req_resigong_dt}
				,NULL
				,NULL
				,ORM_PURCST
				,ORM_NM
				,ORM_GEMP
				,DET_CD
				,ORM_GEMPTEL
				,ORM_HDPHONE
				,PLM_PTM
				,PLM_FTM
				,NULL
				,'C101' 
				,ORM_GPOST
				,ORM_GADDR
				,ORM_GSPC
				,PLM_EVT
				,PLM_CMPYN
				,PLM_ITR
				,ORM_SALEMP
				,ORM_AGTEMP
				,PLM_HCALLYN
				,PLM_RMK
				,'C13W'
				,NULL
				,USR_CD  
				,GETDATE()
				,'2'
				,#{plm_no}
				,ORM_GOOD
				,'Y' 		
				,FST_USR
				,GETDATE()		
		FROM TC_PLANMST WITH (NOLOCK)
		WHERE PLM_NO = #{plm_no}
]]>
</insert> 
 

<insert id="insertSigongMigeulDetailReRequest" parameterType="HashMap">
<![CDATA[
INSERT INTO TC_PLANDTL  
				( 
				 PLM_NO
				,COM_PLDSEC
				,ORD_SSEQ
				,ORD_ISEQ
				,ITM_CD
				,COL_CD
				,SET_CD
				,COL_SCD
				,PLD_EQTY
				,PLD_FQTY
				,ITM_CBM
				,ITM_TOTWGT
				,PLD_FAMT
				,PLD_CRAMT
				,PLD_CFAMT
				,PLD_CUSAMT
				,BMT_SGRADE
				,COM_TRSEC
				,ITM_STCCD
				,PLD_ASSMYN
				,ITM_OVERCMP
				,TRS_SEC
				,COM_STKSEC
				,COM_RDSEC
				,COM_UNDSEC
				,COM_UNPSEC
				,PLD_RCDT
				,PLD_RASDT
				,PLD_RMK
				,USR_CD
				,SYS_DT
				,WTR_NO
				,WTR_SEQNO
				,WTI_NO
				,WTP_NO 
				,PLD_CSEC
				,trs_sec_2
				,FST_USR
				,FST_SYS_DT
				)
                 
		SELECT  
				 #{new_plm_no}
				,COM_PLDSEC
				,ORD_SSEQ
				,ORD_ISEQ
				,ITM_CD
				,COL_CD
				,SET_CD
				,COL_SCD
				,CASE WHEN PLD_EQTY = PLD_FQTY THEN PLD_FQTY ELSE PLD_EQTY - PLD_FQTY END 
				,CASE WHEN PLD_EQTY = PLD_FQTY THEN PLD_FQTY ELSE PLD_EQTY - PLD_FQTY END 
				,ITM_CBM
				,ITM_TOTWGT
				,PLD_FAMT
				,CASE WHEN PLD_EQTY = PLD_FQTY THEN PLD_FQTY * PLD_FAMT ELSE (PLD_EQTY - PLD_FQTY) * PLD_FAMT  END 
				,CASE WHEN PLD_EQTY = PLD_FQTY THEN PLD_FQTY * PLD_FAMT ELSE (PLD_EQTY - PLD_FQTY) * PLD_FAMT  END 
				,PLD_CUSAMT
				,BMT_SGRADE
				,COM_TRSEC
				,ITM_STCCD
				,PLD_ASSMYN
				,ITM_OVERCMP
				,TRS_SEC
				,COM_STKSEC
				,NULL
				,NULL
				,NULL
				,NULL
				,NULL
				,PLD_RMK
				,USR_CD
				,GETDATE()
				,NULL
				,NULL
				,NULL
				,NULL
				,'Y'  
				,trs_sec_2
				,FST_USR
				,GETDATE()
		  FROM TC_PLANDTL WITH (NOLOCK)
		 WHERE 1=1
		   AND PLM_NO		= #{plm_no}
		   AND (COM_PLDSEC	<= 'C096' OR COM_PLDSEC = 'C09A')
		   AND COM_PLDSEC <> 'C0929'
		   AND COM_PLDSEC <> 'C0928'
		   AND COM_RDSEC	= 'C13N'
		   AND PLD_RCDT		> '' 
		
]]>
</insert> 
 
<update id="updateSigonReConfirmInform" parameterType="HashMap">
<![CDATA[
	UPDATE TC_PLANDTL SET COM_UNPSEC = 'C23R', SYS_DT = GETDATE()
	WHERE PLM_NO = #{plm_no}
	   AND COM_RDSEC ='C13N'
	   AND COM_PLDSEC IN('C090','C091','C092','C093','C094','C095','C096','C0930','C09A')

]]>
</update> 

<select id="selectRemSeqNowNo" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.DataResult">        
<![CDATA[

    	SELECT ISNULL(MAX(SEQ_NO), 0) + 1 AS VALUE1
		  FROM TC_SEQNOINF 
		 WHERE COM_AGSEC = #{org_com_agsec}
		   AND COM_NOSEC = 'C08CRS'
		   AND SEQ_SETDT = #{req_resigong_dt}

]]>
</select>

<update id="updateTcSeqnoInfReCreate" parameterType="HashMap">
<![CDATA[
    MERGE INTO TC_SEQNOINF SI
    	 USING (SELECT #{org_com_agsec} AS COM_AGSEC
    	              ,#{req_resigong_dt} AS SEQ_SETDT) A
       		ON SI.COM_AGSEC = A.COM_AGSEC
       	   AND SI.SEQ_SETDT = A.SEQ_SETDT
       	   AND SI.COM_NOSEC = 'C08CRS'
          WHEN MATCHED THEN
            UPDATE 
               SET SEQ_NO = #{now_rem_seq}
          WHEN NOT MATCHED THEN
		    INSERT
		      	  (COM_AGSEC
		      	  ,COM_NOSEC
		      	  ,SEQ_SETDT
		      	  ,SEQ_NO
		      	  ,USR_CD
		      	  ,SYS_DT
		          )    
			VALUES(#{org_com_agsec}
			      ,'C08CRS'
			      ,#{req_resigong_dt}
			      ,#{now_rem_seq}
			      ,NULL
			      ,GETDATE()
			      );

]]>
</update> 

<insert id="insertNewTcResmst" parameterType="HashMap">
<![CDATA[
      INSERT INTO TC_RESMST
           (REM_DT		  /* 서비스예약일 */	
           ,REM_SEQ       /* 예약순번 */
           ,PLM_NO        /* 시공번호 */
           ,ORM_NO        /* 수주번호 */
           ,PRJ_CD        /* 프로젝트번호 */
           ,REM_PTM       /* 요청시간 */
           ,REM_FTM       /* 확정시간 */
           ,REM_TMFYN     /* 시간업수건수 */
           ,REM_NTM       /* 예상소요시간 */
           ,PLM_ETM       /* 종료시간 */
           ,PLM_FIXEDT    /* 확정종료일 */
           ,COM_AGSEC     /* 회사 */
           ,COM_SSEC      /* 서비스구분 */
           ,STI_CD        /* 시공팀코드 */
           ,COM_CTSEC     /* 시공팀구분 */
           ,SAC_CD        /* 서비스지역코드 */
           ,ORM_AMT       /* 수주금액 */
           ,ORM_PURCST    /* 구매고객코드 */
           ,ORM_NM        /* 수주건명 */
           ,REM_CLAMT     /* 시공난이도금액 */
           ,COM_SCD       /* 서비스센터코드 */
           ,STM_NO        /* 서비스팀원번호 */
           ,AGT_CD        /* 대리점코드 */
           ,COM_RFG       /* 예약상태 */
           ,REM_ASNO      /* AS접수순번 */
           ,REM_RMK       /* 비고 */
           ,ZIP_CD        /* 우편번호 */
           ,USR_CD        /* 최종변경자 */
           ,SYS_DT        /* 최종변경일시 */
           ,REM_EXTYN     /* 추가요청건유무 */
           ,REM_CASYN     /* AS건시공예약유무 */
           ,REM_CSEC      /* 생성구분 */
           ,REM_VTM       /* 계획시간 */
           ,TREQ_TIME     /* 운송요청시간 */
           ,STI_REQTM     /* 시공팀변경요청시간 */
           ,SCHDIV_YN     /* 서비스예약정보 */
           ,SIGN_DT       /* 전자서명등록일시 */
           ,REM_PTM_2     /* 요청시간2 */
           ,REM_FTM_2     /* 확정시간2 */
           ,TOWN_CD       /* 법정동코드 */
           ,COM_BRAND     /* 브랜드 */
           ,FST_USR       /* 최초등록자 */
           ,FST_SYS_DT    /* 최초등록일시 */
           )
    VALUES (#{req_resigong_dt}
           ,RTRIM(#{new_rem_seq})
           ,#{new_plm_no}
           ,#{org_orm_no}
           ,''
           ,ISNULL((SELECT TTC.CCD_CD FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CDX_CD = 'C70' AND CCD_NAME = #{req_rem_ftm}), 'C4133')
           ,ISNULL((SELECT TTC.CCD_CD FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CDX_CD = 'C70' AND CCD_NAME = #{req_rem_ftm}), 'C4133')
           ,'N'
           ,'0'
           ,NULL
           ,NULL
           ,#{org_com_agsec}
           ,'C18C'
           ,#{org_sti_cd}
           ,'C06L'
           ,NULL
           ,(SELECT TCR.ORM_AMT
               FROM TC_RESMST TCR WITH (NOLOCK)
              WHERE TCR.REM_DT = #{org_rem_dt}
                AND TCR.PLM_NO = #{plm_no}
                AND TCR.COM_SSEC = 'C18C' )
           ,(SELECT TCR.ORM_PURCST
               FROM TC_RESMST TCR WITH (NOLOCK)
              WHERE TCR.REM_DT = #{org_rem_dt}
                AND TCR.PLM_NO = #{plm_no}
                AND TCR.COM_SSEC = 'C18C' )
           ,(SELECT TCR.ORM_NM
               FROM TC_RESMST TCR WITH (NOLOCK)
              WHERE TCR.REM_DT = #{org_rem_dt}
                AND TCR.PLM_NO = #{plm_no}
                AND TCR.COM_SSEC = 'C18C' )
           ,(SELECT TCR.REM_CLAMT
               FROM TC_RESMST TCR WITH (NOLOCK)
              WHERE TCR.REM_DT = #{org_rem_dt}
                AND TCR.PLM_NO = #{plm_no}
                AND TCR.COM_SSEC = 'C18C' )
           ,#{org_com_scd}
           ,'01'
           ,#{org_agt_cd}
           ,'C141'
           ,NULL
           ,LEFT((SELECT TCS.STI_NM 
               FROM TC_STINF TCS WITH (NOLOCK) 
              WHERE TCS.STI_CD = #{org_sti_cd_get} 
                AND TCS.COM_SCD = #{org_com_scd} ) + ' 팀, 원시공일 : '+ #{org_rem_dt} + ' ' + ISNULL((SELECT TCP.MOB_REMARK 
                      																			   FROM TC_PLANMST TCP WITH (NOLOCK) 
                    																			  WHERE TCP.PLM_NO = #{plm_no} ), ''), 50)
           ,#{org_orm_gpost}
           ,#{sti_cd}
           ,GETDATE()
           ,'Y'
           ,'N'
           ,'R'
           ,NULL
           ,NULL
           ,NULL
           ,'N'
           ,NULL
           ,'C4133'
           ,'C4133'
           ,#{org_town_cd}
           ,#{org_com_brand}
           ,#{org_sti_cd}
           ,GETDATE()    
           )
		
]]>
</insert> 


<insert id="insertNewTcResdtl" parameterType="HashMap">
<![CDATA[
    INSERT 
      INTO TC_RESDTL  
		   (REM_DT          /* 서비스예약일 */   
		   ,REM_SEQ         /* 예약순번 */
		   ,RED_CELNO       /* cell순번 */
		   ,RED_CELTM       /* cell시간 */
		   ,REM_TMFYN       /* 시간엄수구분 */
		   ,USR_CD          /* 최종변경자 */
		   ,SYS_DT          /* 최종변경일시 */
		   )  
	VALUES (#{req_resigong_dt}
		   ,#{new_rem_seq}
		   ,'0001' 
		   ,'C4133'
		   ,'N'
		   ,#{sti_cd}  
		   ,GETDATE()
		   )
]]>
</insert> 

<update id="modifyOrmPsts_U" parameterType="HashMap">
<![CDATA[
    UPDATE /* OOR0010.modifyOrmPsts_U : 수주예약상태 수정 */ O
       SET O.ORM_PSTS = 'E'    /* 예약상태 */
          ,O.USR_CD   = #{sti_cd}
          ,O.SYS_DT   = GETDATE()     /* 최종변경일시 */
		 ,O.PAY_DUE_DT = (SELECT CASE WHEN ISNULL(O.PAY_DUE_DT,'') != '' AND ISNULL(O.ORM_CDT,'') != ''
		 									AND O.ORM_CDT > DBO.FN_GET_PAY_DUE_DT(O.VND_CD,O.ORM_CDT,O.COM_BRD)
		 									AND NOT EXISTS (SELECT 1
		 													FROM TC_RESMST A
		 													INNER JOIN TC_PLANMST B ON A.ORM_NO = B.ORM_NO AND A.REM_DT = B.PLM_CDT
															WHERE A.ORM_NO = O.ORM_NO AND  A.COM_SSEC = 'C18C' AND  A.COM_RFG = 'C141' AND B.PLM_PNO IS NOT NULL)
		 							THEN
							  				CONVERT(DATETIME,CONCAT(CONVERT(CHAR(10),CONVERT(DATE, DBO.FN_GET_PAY_DUE_DT(O.VND_CD,O.ORM_CDT,O.COM_BRD) ),120),' 23:59:59.990'))
							  		ELSE
							  				O.PAY_DUE_DT
							   		END)
		   
	  FROM TO_ORDMAS O
     WHERE O.ORM_NO = #{org_orm_no}

]]>
</update> 

 
<insert id="insertNewTcResmst_org" parameterType="HashMap">
<![CDATA[
      INSERT INTO TC_RESMST
           (REM_DT		  /* 서비스예약일 */	
           ,REM_SEQ       /* 예약순번 */
           ,PLM_NO        /* 시공번호 */
           ,ORM_NO        /* 수주번호 */
           ,PRJ_CD        /* 프로젝트번호 */
           ,REM_PTM       /* 요청시간 */
           ,REM_FTM       /* 확정시간 */
           ,REM_TMFYN     /* 시간업수건수 */
           ,REM_NTM       /* 예상소요시간 */
           ,PLM_ETM       /* 종료시간 */
           ,PLM_FIXEDT    /* 확정종료일 */
           ,COM_AGSEC     /* 회사 */
           ,COM_SSEC      /* 서비스구분 */
           ,STI_CD        /* 시공팀코드 */
           ,COM_CTSEC     /* 시공팀구분 */
           ,SAC_CD        /* 서비스지역코드 */
           ,ORM_AMT       /* 수주금액 */
           ,ORM_PURCST    /* 구매고객코드 */
           ,ORM_NM        /* 수주건명 */
           ,REM_CLAMT     /* 시공난이도금액 */
           ,COM_SCD       /* 서비스센터코드 */
           ,STM_NO        /* 서비스팀원번호 */
           ,AGT_CD        /* 대리점코드 */
           ,COM_RFG       /* 예약상태 */
           ,REM_ASNO      /* AS접수순번 */
           ,REM_RMK       /* 비고 */
           ,ZIP_CD        /* 우편번호 */
           ,USR_CD        /* 최종변경자 */
           ,SYS_DT        /* 최종변경일시 */
           ,REM_EXTYN     /* 추가요청건유무 */
           ,REM_CASYN     /* AS건시공예약유무 */
           ,REM_CSEC      /* 생성구분 */
           ,REM_VTM       /* 계획시간 */
           ,TREQ_TIME     /* 운송요청시간 */
           ,STI_REQTM     /* 시공팀변경요청시간 */
           ,SCHDIV_YN     /* 서비스예약정보 */
           ,SIGN_DT       /* 전자서명등록일시 */
           ,REM_PTM_2     /* 요청시간2 */
           ,REM_FTM_2     /* 확정시간2 */
           ,TOWN_CD       /* 법정동코드 */
           ,COM_BRAND     /* 브랜드 */
           ,FST_USR       /* 최초등록자 */
           ,FST_SYS_DT    /* 최초등록일시 */
           )
    VALUES (#{req_resigong_dt}
           ,RTRIM(#{new_rem_seq})
           ,#{new_plm_no}
           ,#{org_orm_no}
           ,''
           ,ISNULL((SELECT TTC.CCD_CD FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CDX_CD = 'C70' AND CCD_NAME = #{req_rem_ftm}), 'C4133')
           ,ISNULL((SELECT TTC.CCD_CD FROM TT_COMCD TTC WITH (NOLOCK) WHERE TTC.CDX_CD = 'C70' AND CCD_NAME = #{req_rem_ftm}), 'C4133')
           ,'N'
           ,'0'
           ,NULL
           ,NULL
           ,#{org_com_agsec}
           ,'C18C'
           ,#{org_sti_cd}
           ,'C06L'
           ,NULL
           ,(SELECT TCR.ORM_AMT
               FROM TC_RESMST TCR WITH (NOLOCK)
              WHERE TCR.REM_DT = #{org_rem_dt}
                AND TCR.PLM_NO = #{plm_no}
                AND TCR.COM_SSEC = 'C18C' )
           ,(SELECT TCR.ORM_PURCST
               FROM TC_RESMST TCR WITH (NOLOCK)
              WHERE TCR.REM_DT = #{org_rem_dt}
                AND TCR.PLM_NO = #{plm_no}
                AND TCR.COM_SSEC = 'C18C' )
           ,(SELECT TCR.ORM_NM
               FROM TC_RESMST TCR WITH (NOLOCK)
              WHERE TCR.REM_DT = #{org_rem_dt}
                AND TCR.PLM_NO = #{plm_no}
                AND TCR.COM_SSEC = 'C18C' )
           ,(SELECT TCR.REM_CLAMT
               FROM TC_RESMST TCR WITH (NOLOCK)
              WHERE TCR.REM_DT = #{org_rem_dt}
                AND TCR.PLM_NO = #{plm_no}
                AND TCR.COM_SSEC = 'C18C' )
           ,#{org_com_scd}
           ,'01'
           ,#{org_agt_cd}
           ,'C141'
           ,NULL
           ,LEFT((SELECT TCS.STI_NM 
               FROM TC_STINF TCS WITH (NOLOCK) 
              WHERE TCS.STI_CD = #{org_sti_cd} 
                AND TCS.COM_SCD = #{org_com_scd} ) + ' 팀, 원시공일 : '+ #{org_rem_dt} + ' ' + ISNULL((SELECT TCP.MOB_REMARK 
                      																			   FROM TC_PLANMST TCP WITH (NOLOCK) 
                    																			  WHERE TCP.PLM_NO = #{plm_no} ), ''), 50)
           ,#{org_orm_gpost}
           ,#{sti_cd}
           ,GETDATE()
           ,'Y'
           ,'N'
           ,'R'
           ,NULL
           ,NULL
           ,NULL
           ,'N'
           ,NULL
           ,'C4133'
           ,'C4133'
           ,#{org_town_cd}
           ,#{org_com_brand}
           ,#{org_sti_cd}
           ,GETDATE()    
           )
		
]]>
</insert> 


<select id="selectOriginalStiTeamGet" parameterType="HashMap" resultType="com.fursys.mobilecm.vo.DataResult">
<![CDATA[

    SELECT TOP 1 TS.STI_CD AS DATA1              /* 시공팀코드 */ 
	  FROM TC_TOWND TD
	 INNER JOIN TC_STINF TS
	    ON TD.STI_CD = TS.STI_CD
	 WHERE TD.COM_AGSEC = #{org_com_agsec}
	   AND TD.COM_BRAND = #{org_com_brand}
	   AND TD.TOWN_CD   = #{org_town_cd}
	   AND TS.COM_SCD   = #{org_com_scd}
	   AND TS.STI_RANK = 'Y' 
	
]]>
</select>

</mapper>